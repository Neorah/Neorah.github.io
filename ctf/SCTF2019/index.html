<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="[SCTF2019]Web Writeup"><meta name="keywords" content="ERB注入,ruby"><meta name="author" content="Neorah"><meta name="copyright" content="Neorah"><title>[SCTF2019]Web Writeup | Neorah's Blog</title><link rel="shortcut icon" href="/img/melody-favicon32.ico"><link rel="stylesheet" href="/css/index.css?version=1.7.0"><link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/4.7.0/css/font-awesome.min.css?version=1.7.0"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.1.1/dist/instantsearch.min.css"><script src="https://cdn.jsdelivr.net/npm/instantsearch.js@2.1.1/dist/instantsearch.min.js" defer></script><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: {"appId":"DBINOT6FYU","apiKey":"c8bb9d887053d084aa4aee885c26cac5","indexName":"dev_Neorah","hits":{"per_page":10},"languages":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}.","hits_stats":"${hits} results found in ${time} ms"}},
  localSearch: undefined,
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  }
} </script><meta name="generator" content="Hexo 4.2.0"></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="Toggle article">Toggle site</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Flag-Shop"><span class="toc-number">1.</span> <span class="toc-text">Flag Shop</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#解题思路"><span class="toc-number">1.0.1.</span> <span class="toc-text">解题思路</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#找到源码"><span class="toc-number">1.0.2.</span> <span class="toc-text">找到源码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ERB模版注入"><span class="toc-number">1.0.3.</span> <span class="toc-text">ERB模版注入</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#解题"><span class="toc-number">1.0.4.</span> <span class="toc-text">解题</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#待补充的题"><span class="toc-number">2.</span> <span class="toc-text">待补充的题</span></a></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="/img/neorah.jpg"></div><div class="author-info__name text-center">Neorah</div><div class="author-info__description text-center"></div><div class="follow-button"><a href="https://github.com/Neorah" target="_blank" rel="noopener">Follow Me</a></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">Articles</span><span class="pull-right">42</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">Tags</span><span class="pull-right">37</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">Categories</span><span class="pull-right">36</span></a></div><hr><div class="author-info-links"><div class="author-info-links__title text-center">Friends</div><a class="author-info-links__name text-center" href="http://blog.happysec.cn" target="_blank" rel="noopener">小北</a><a class="author-info-links__name text-center" href="https://ha1c9on.top/" target="_blank" rel="noopener">ha1c9on</a><a class="author-info-links__name text-center" href="http://www.const27.com" target="_blank" rel="noopener">const27</a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(/img/top.JPG)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">Neorah's Blog</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Posts</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a><a class="site-page" href="/about">About</a></span><span class="pull-right"><a class="site-page social-icon search"><i class="fa fa-search"></i><span> Search</span></a></span></div><div id="post-info"><div id="post-title">[SCTF2019]Web Writeup</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-06-02</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/ctf/">ctf</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/ctf/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/">代码审计</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/ctf/%E6%A8%A1%E7%89%88%E6%B3%A8%E5%85%A5/">模版注入</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/ctf/%E4%BC%AA%E9%80%A0cookie/">伪造cookie</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/ctf/%E6%A8%A1%E7%89%88%E6%B3%A8%E5%85%A5/ERB%E6%B3%A8%E5%85%A5/">ERB注入</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/ctf/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/ruby/">ruby</a><div class="post-meta-wordcount"><span>Word count: </span><span class="word-count">1.4k</span><span class="post-meta__separator">|</span><span>Reading time: 5 min</span></div></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><h1 id="Flag-Shop"><a href="#Flag-Shop" class="headerlink" title="Flag Shop"></a>Flag Shop</h1><h3 id="解题思路"><a href="#解题思路" class="headerlink" title="解题思路"></a>解题思路</h3><img src="/ctf/SCTF2019/1.png" class=""> 

<p>刚打开是这样。界面里有uid、jkl、flag price.点击Buy flag按钮</p>
<img src="/ctf/SCTF2019/2.png" class="">

<p>jkl不够，我们需要有足够的jkl才能买到flag。</p>
<p>点击reset按钮会重置uid、jkl个数，没什么特别的用处。</p>
<p>点击work，注意到jkl会随机增加，但是增加个数在10个以内，因此就算是用脚本跑也要跑很久很久很久很久。所以另找办法。</p>
<p>我们看看网页的源代码：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">work</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    fetch(<span class="string">"/work?name=bot&amp;do=bot is working"</span>)</span><br><span class="line">        .then(()=&gt;window.location.reload());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fetch(<span class="string">"/api/info"</span>,&#123;</span><br><span class="line">        redirect: <span class="string">'manual'</span></span><br><span class="line">    &#125;)</span><br><span class="line">    .then(<span class="function"><span class="keyword">function</span> <span class="params">(res)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span>(res.ok)&#123;</span><br><span class="line">          <span class="keyword">return</span> res.json()</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span>&#123;</span><br><span class="line">          fetch(<span class="string">"/api/auth"</span>)</span><br><span class="line">          reject;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    .then(res=&gt;&#123;</span><br><span class="line">        <span class="keyword">var</span> info = res;</span><br><span class="line">        console.log(info);</span><br><span class="line">        document.getElementById(<span class="string">"uid"</span>).innerText = info.uid;</span><br><span class="line">        document.getElementById(<span class="string">"jkl"</span>).innerText = info.jkl;</span><br><span class="line">    &#125;)</span><br><span class="line">    .<span class="keyword">catch</span>(error =&gt; setTimeout(()=&gt;window.location.reload(),<span class="number">500</span>))</span><br></pre></td></tr></table></figure>

<p>可以大致看出来工作流程，先获取信息，失败后请求auth，然后会有个jwt token。再每次work后都会输入生成新的cookie。</p>
<p>让我们看看cookie，再把他丢到jwt.io里解码一下：</p>
<img src="/ctf/SCTF2019/3.png" class="">

<p>因此我们想到，可以在jwt中修改jkl，使它达到能够购买flag需要的数量，再把构造好的cookie替换到题目里，就能成功买到flag了，买成功之后就会返回一个新的cookie，再解码应该就能够得到flag了。</p>
<p>但伪造cookie需要得到SIGNATURE，因此我们得找到源代码才能看出SIGNATURE是怎么来的。</p>
<h3 id="找到源码"><a href="#找到源码" class="headerlink" title="找到源码"></a>找到源码</h3><p>扫目录发现有个<code>robots.txt</code>，让我们进去看看</p>
<img src="/ctf/SCTF2019/4.png" class="">

<p>再进<code>/filebak</code>里面去看看，发现是源码，是用ruby写的。</p>
<img src="/ctf/SCTF2019/5.png" class="">

<p>让我们来看关键代码：</p>
<figure class="highlight ruby"><table><tr><td class="code"><pre><span class="line">get <span class="string">"/work"</span> <span class="keyword">do</span></span><br><span class="line">  islogin</span><br><span class="line">  auth = JWT.decode cookies[<span class="symbol">:auth</span>],ENV[<span class="string">"SECRET"</span>] , <span class="literal">true</span>, &#123; <span class="symbol">algorithm:</span> <span class="string">'HS256'</span> &#125;</span><br><span class="line">  auth = auth[<span class="number">0</span>]</span><br><span class="line">  <span class="keyword">unless</span> params[<span class="symbol">:SECRET</span>].<span class="literal">nil</span>?</span><br><span class="line">    <span class="keyword">if</span> ENV[<span class="string">"SECRET"</span>].match(<span class="string">"<span class="subst">#&#123;params[<span class="symbol">:SECRET</span>].match(<span class="regexp">/[0-9a-z]+/</span>)&#125;</span>"</span>)</span><br><span class="line">      puts ENV[<span class="string">"FLAG"</span>]</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> params[<span class="symbol">:do</span>] == <span class="string">"<span class="subst">#&#123;params[<span class="symbol">:name</span>][<span class="number">0</span>,<span class="number">7</span>]&#125;</span> is working"</span> <span class="keyword">then</span></span><br><span class="line"></span><br><span class="line">    auth[<span class="string">"jkl"</span>] = auth[<span class="string">"jkl"</span>].to_i + SecureRandom.random_number(<span class="number">10</span>)</span><br><span class="line">    auth = JWT.encode auth,ENV[<span class="string">"SECRET"</span>] , <span class="string">'HS256'</span></span><br><span class="line">    cookies[<span class="symbol">:auth</span>] = auth</span><br><span class="line">    ERB::new(<span class="string">"&lt;script&gt;alert('<span class="subst">#&#123;params[<span class="symbol">:name</span>][<span class="number">0</span>,<span class="number">7</span>]&#125;</span> working successfully!')&lt;/script&gt;"</span>).result</span><br><span class="line"></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>从<code>ERB::new(&quot;&lt;script&gt;alert(&#39;#{params[:name][0,7]} working successfully!&#39;)&lt;/script&gt;&quot;)</code>看出直接用了ERB模版，并且还将可控参数name直接拼接进去了，以alert的方式回显在页面上。因此我们可以在可控参数name处传入一些构造过的参数。</p>
<h3 id="ERB模版注入"><a href="#ERB模版注入" class="headerlink" title="ERB模版注入"></a>ERB模版注入</h3><p>ERB代表嵌入式Ruby，用于在模板中插入Ruby变量，例如HTML和YAML。 ERB是一个Ruby类，它接受文本，并评估和替换ERB标记包围的Ruby代码。它的模版格式为：</p>
<figure class="highlight ruby"><table><tr><td class="code"><pre><span class="line">&lt;%= <span class="number">7</span>*<span class="number">7</span> %&gt;</span><br><span class="line">&lt;%= File.open(<span class="string">'/etc/passwd'</span>).read %&gt; <span class="comment">#查看文件</span></span><br><span class="line">&lt;%= <span class="keyword">self</span><span class="class">.<span class="keyword">class</span>.<span class="title">name</span> %&gt;  <span class="comment">#获取self对象的类名</span></span></span><br><span class="line">&lt;%= <span class="keyword">self</span>.methods %&gt;  <span class="comment">#枚举类的可用方法</span></span><br><span class="line">&lt;%= <span class="keyword">self</span>.method(<span class="symbol">:handle_POST</span>).parameters %&gt;  <span class="comment">#获取函数所需的具体参数</span></span><br></pre></td></tr></table></figure>

<p>从以上我们了解到<code>&lt;%=</code>语法可以用来执行Ruby语句，并会尝试将结果转换为字符串，以附在最终的结果文本中。并且此处限定了只能输入7个字符以内。</p>
<p>并且ERB注入跟sql注入等的原理很相似，都是插入的代码被执行了。因此我们这里就可以通过name传入代码，执行结果就会alert出执行结果。例如<code>name=&lt;%=1%&gt;</code>,并且需要先url编码一下，防止特殊字符的影响。</p>
<img src="/ctf/SCTF2019/6.png" class="">

<h3 id="解题"><a href="#解题" class="headerlink" title="解题"></a>解题</h3><p>上上上一步说到，我们找源码的原因是要得到伪造cookie所需要的签名。让我们来看看源码中关于cookie的处理代码。</p>
<figure class="highlight ruby"><table><tr><td class="code"><pre><span class="line">get <span class="string">"/work"</span> <span class="keyword">do</span></span><br><span class="line">  islogin</span><br><span class="line">  auth = JWT.decode cookies[<span class="symbol">:auth</span>],ENV[<span class="string">"SECRET"</span>] , <span class="literal">true</span>, &#123; <span class="symbol">algorithm:</span> <span class="string">'HS256'</span> &#125;</span><br><span class="line">  auth = auth[<span class="number">0</span>]</span><br><span class="line">  <span class="keyword">unless</span> params[<span class="symbol">:SECRET</span>].<span class="literal">nil</span>?</span><br><span class="line">    <span class="keyword">if</span> ENV[<span class="string">"SECRET"</span>].match(<span class="string">"<span class="subst">#&#123;params[<span class="symbol">:SECRET</span>].match(<span class="regexp">/[0-9a-z]+/</span>)&#125;</span>"</span>)</span><br><span class="line">      puts ENV[<span class="string">"FLAG"</span>]</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>可以看出，cookie是需要<code>ENV[&quot;SECRET&quot;]</code>作为签名得到的。因此我们如果能得到每次work后的<code>ENV[&quot;SECRET&quot;]</code>，就可以伪造cookie了！</p>
<p>这段代码的后半部分说明了，在ERB模版渲染以前有一个正则匹配。如果SECRET参数存在的话，就对其进行匹配，并用传入的值与<code>ENV[&quot;SECRET&quot;]</code>进行匹配，匹配成功就会输出FLAG。如果我们不传SECRET，这样括号里的匹配就不进行，只进行括号外的 ENV[“SECRET”] 的匹配。</p>
<ul>
<li>ruby全局变量</li>
</ul>
<p>​       ruby的全局变量以<code>$</code>开头，例如: <code>$x</code>,<code>$y</code> 。全局变量可以在程序的任何地方加以引用。全局变量无需变量声明。引用尚未初始化的全局变量时，其值为<strong>nil</strong>。并且ruby有内置的全局变量表，在<a href="https://blog.csdn.net/zdq0394123/article/details/8443694" target="_blank" rel="noopener">这里</a>。</p>
<img src="/ctf/SCTF2019/11.png" class="">

<p>这里既然有匹配，那说明我们就可以用全局变量读出来了，也就是可以用上图的符号来读取匹配前的内容（即<code>ENV[&quot;SECRET&quot;]</code>）</p>
<p>因此我们可以构造，再进行url编码后传入。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">name&#x3D;&lt;%&#x3D;$&#39;%&gt;&amp;do&#x3D;&lt;%&#x3D;$&#39;%&gt; is working&amp;SECRET&#x3D;</span><br></pre></td></tr></table></figure>

<img src="/ctf/SCTF2019/8.png" class="">

<p>得到SECRET了，再把他拿到jwt.io里进行编码，并把jkl数量设置为大于flag的购买数量。</p>
<img src="/ctf/SCTF2019/9.png" class="">

<p>再把新的cookie替换到题目中，显示购买成功了。</p>
<img src="/ctf/SCTF2019/10.png" class="">

<figure class="highlight ruby"><table><tr><td class="code"><pre><span class="line">post <span class="string">"/shop"</span> <span class="keyword">do</span></span><br><span class="line">  islogin</span><br><span class="line">  auth = JWT.decode cookies[<span class="symbol">:auth</span>],ENV[<span class="string">"SECRET"</span>] , <span class="literal">true</span>, &#123; <span class="symbol">algorithm:</span> <span class="string">'HS256'</span> &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> auth[<span class="number">0</span>][<span class="string">"jkl"</span>] &lt; FLAGPRICE <span class="keyword">then</span></span><br><span class="line"></span><br><span class="line">    json(&#123;<span class="symbol">title:</span> <span class="string">"error"</span>,<span class="symbol">message:</span> <span class="string">"no enough jkl"</span>&#125;)</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line"></span><br><span class="line">    auth &lt;&lt; &#123;<span class="symbol">flag:</span> ENV[<span class="string">"FLAG"</span>]&#125;</span><br><span class="line">    auth = JWT.encode auth,ENV[<span class="string">"SECRET"</span>] , <span class="string">'HS256'</span></span><br><span class="line">    cookies[<span class="symbol">:auth</span>] = auth</span><br><span class="line">    json(&#123;<span class="symbol">title:</span> <span class="string">"success"</span>,<span class="symbol">message:</span> <span class="string">"jkl is good thing"</span>&#125;)</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>在关于shop的源码中可以看到，购买成功后，flag将会jwt编码。因此我们只需要把返回的新cookie拿去解码就能得到flag了！</p>
<h1 id="待补充的题"><a href="#待补充的题" class="headerlink" title="待补充的题"></a>待补充的题</h1><p>这个比赛的剩下两个题都太难了qaq我看赵师傅的wp都看不懂，先做能够理解一点的题之后再来看这些难题8。</p>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">Neorah</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="https://neorah.me/ctf/SCTF2019/">https://neorah.me/ctf/SCTF2019/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/" target="_blank" rel="noopener">CC BY-NC-SA 3.0</a> unless stating additionally.</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/ERB%E6%B3%A8%E5%85%A5/">ERB注入</a><a class="post-meta__tags" href="/tags/ruby/">ruby</a></div><nav id="pagination"><div class="prev-post pull-left"><a href="/%E6%B0%B4%E6%96%87/pentestabout/"><i class="fa fa-chevron-left">  </i><span>关于渗透测试的一点想法</span></a></div><div class="next-post pull-right"><a href="/mycat/"><span>绝美十一宝贝高清美图</span><i class="fa fa-chevron-right"></i></a></div></nav></div></div><footer class="footer-bg" style="background-image: url(/img/top.JPG)"><div class="layout" id="footer"><div class="copyright">&copy;2020 By Neorah</div><div class="footer_custom_text">Theme By melody</div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file-o"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="/js/third-party/anime.min.js"></script><script src="/js/third-party/jquery.min.js"></script><script src="/js/third-party/jquery.fancybox.min.js"></script><script src="/js/third-party/velocity.min.js"></script><script src="/js/third-party/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.7.0"></script><script src="/js/fancybox.js?version=1.7.0"></script><script src="/js/sidebar.js?version=1.7.0"></script><script src="/js/copy.js?version=1.7.0"></script><script src="/js/fireworks.js?version=1.7.0"></script><script src="/js/transition.js?version=1.7.0"></script><script src="/js/scroll.js?version=1.7.0"></script><script src="/js/head.js?version=1.7.0"></script><script src="/js/search/algolia.js"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script><div class="search-dialog" id="algolia-search"><div class="search-dialog__title" id="algolia-search-title">Algolia</div><div id="algolia-input-panel"><div id="algolia-search-input"></div></div><hr><div id="algolia-search-results"><div id="algolia-hits"></div><div id="algolia-pagination"></div><div id="algolia-stats"></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div></body></html>