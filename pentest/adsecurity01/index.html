<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="[翻译和复现]Attack Methods for Gaining Domain Admin Rights in Active Directory"><meta name="keywords" content="域渗透"><meta name="author" content="Neorah"><meta name="copyright" content="Neorah"><title>[翻译和复现]Attack Methods for Gaining Domain Admin Rights in Active Directory | Neorah's Blog</title><link rel="shortcut icon" href="/img/melody-favicon32.ico"><link rel="stylesheet" href="/css/index.css?version=1.7.0"><link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/4.7.0/css/font-awesome.min.css?version=1.7.0"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.1.1/dist/instantsearch.min.css"><script src="https://cdn.jsdelivr.net/npm/instantsearch.js@2.1.1/dist/instantsearch.min.js" defer></script><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: {"appId":"DBINOT6FYU","apiKey":"c8bb9d887053d084aa4aee885c26cac5","indexName":"dev_Neorah","hits":{"per_page":10},"languages":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}.","hits_stats":"${hits} results found in ${time} ms"}},
  localSearch: undefined,
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  }
} </script><meta name="generator" content="Hexo 4.2.0"></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="Toggle article">Toggle site</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#0x00-前言"><span class="toc-number">1.</span> <span class="toc-text">0x00 前言</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x01-Passwords-in-SYSVOL-amp-Group-Policy-Preferences"><span class="toc-number">2.</span> <span class="toc-text">0x01. Passwords in SYSVOL &amp; Group Policy Preferences</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#介绍"><span class="toc-number">2.1.</span> <span class="toc-text">介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#解决方案"><span class="toc-number">2.2.</span> <span class="toc-text">解决方案</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x02-Exploit-the-MS14-068-Kerberos-Vulnerability-on-a-Domain-Controller-Missing-the-Patch"><span class="toc-number">3.</span> <span class="toc-text">0x02. Exploit the MS14-068 Kerberos Vulnerability on a Domain Controller Missing the Patch</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#介绍-1"><span class="toc-number">3.1.</span> <span class="toc-text">介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#复现"><span class="toc-number">3.2.</span> <span class="toc-text">复现</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#测试环境"><span class="toc-number">3.2.1.</span> <span class="toc-text">测试环境</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#测试步骤"><span class="toc-number">3.2.2.</span> <span class="toc-text">测试步骤</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#MS14-068利用过程"><span class="toc-number">3.3.</span> <span class="toc-text">MS14-068利用过程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#解决方案-1"><span class="toc-number">3.4.</span> <span class="toc-text">解决方案</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x03-Kerberos-TGS-Service-Ticket-Offline-Cracking-Kerberoast"><span class="toc-number">4.</span> <span class="toc-text">0x03. Kerberos TGS Service Ticket Offline Cracking (Kerberoast)</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#介绍-2"><span class="toc-number">4.1.</span> <span class="toc-text">介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#复现-1"><span class="toc-number">4.2.</span> <span class="toc-text">复现</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#实验环境"><span class="toc-number">4.2.1.</span> <span class="toc-text">实验环境</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#实验目标"><span class="toc-number">4.2.2.</span> <span class="toc-text">实验目标</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#实验步骤"><span class="toc-number">4.2.3.</span> <span class="toc-text">实验步骤</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#注册SPN"><span class="toc-number">4.2.3.1.</span> <span class="toc-text">注册SPN</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#获取有价值的SPN"><span class="toc-number">4.2.3.2.</span> <span class="toc-text">获取有价值的SPN</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#请求TGS"><span class="toc-number">4.2.3.3.</span> <span class="toc-text">请求TGS</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#破解"><span class="toc-number">4.2.3.4.</span> <span class="toc-text">破解</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#解决方案-2"><span class="toc-number">4.3.</span> <span class="toc-text">解决方案</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x04-The-Credential-Theft-Shuffle"><span class="toc-number">5.</span> <span class="toc-text">0x04. The Credential Theft Shuffle</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#介绍-3"><span class="toc-number">5.1.</span> <span class="toc-text">介绍</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x05-Pass-the-hash-evolves-into-Pass-the-Credential"><span class="toc-number">6.</span> <span class="toc-text">0x05. Pass the hash evolves into Pass-the-Credential</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#介绍-4"><span class="toc-number">6.1.</span> <span class="toc-text">介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#解决方案-3"><span class="toc-number">6.2.</span> <span class="toc-text">解决方案</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x06-Gain-Access-to-the-Active-Directory-Database-File-ntds-dit"><span class="toc-number">7.</span> <span class="toc-text">0x06. Gain Access to the Active Directory Database File (ntds.dit)</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#介绍-5"><span class="toc-number">7.1.</span> <span class="toc-text">介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#解决方案-4"><span class="toc-number">7.2.</span> <span class="toc-text">解决方案</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#复现-2"><span class="toc-number">7.3.</span> <span class="toc-text">复现</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#参考"><span class="toc-number">8.</span> <span class="toc-text">参考</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#本文参考"><span class="toc-number">8.1.</span> <span class="toc-text">本文参考</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#翻译及复现参考"><span class="toc-number">8.2.</span> <span class="toc-text">翻译及复现参考</span></a></li></ol></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="/img/neorah.jpg"></div><div class="author-info__name text-center">Neorah</div><div class="author-info__description text-center"></div><div class="follow-button"><a href="https://github.com/Neorah" target="_blank" rel="noopener">Follow Me</a></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">Articles</span><span class="pull-right">45</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">Tags</span><span class="pull-right">38</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">Categories</span><span class="pull-right">37</span></a></div><hr><div class="author-info-links"><div class="author-info-links__title text-center">Friends</div><a class="author-info-links__name text-center" href="http://blog.happysec.cn" target="_blank" rel="noopener">小北</a><a class="author-info-links__name text-center" href="https://ha1c9on.top/" target="_blank" rel="noopener">ha1c9on</a><a class="author-info-links__name text-center" href="http://www.const27.com" target="_blank" rel="noopener">const27</a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(/img/top.JPG)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">Neorah's Blog</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Posts</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a><a class="site-page" href="/about">About</a></span><span class="pull-right"><a class="site-page social-icon search"><i class="fa fa-search"></i><span> Search</span></a></span></div><div id="post-info"><div id="post-title">[翻译和复现]Attack Methods for Gaining Domain Admin Rights in Active Directory</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2021-01-23</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/">渗透测试</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/%E5%9F%9F%E6%B8%97%E9%80%8F/">域渗透</a><div class="post-meta-wordcount"><span>Word count: </span><span class="word-count">7.9k</span><span class="post-meta__separator">|</span><span>Reading time: 25 min</span></div></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><p>以前没有怎么从头到尾翻译过英文文章，所以在此篇文章中可能有不恰当之处，还希望大佬们能指出。</p>
<p>建议先阅读这篇<a href="https://www.anquanke.com/post/id/171552" target="_blank" rel="noopener">文章</a>。对Kerberos协议以及下文会提到的一些名词缩写在这篇文章中都有非常清晰的解释。</p>
<p>原文链接：<a href="https://adsecurity.org/?p=2362#more-2362" target="_blank" rel="noopener">Attack Methods for Gaining Domain Admin Rights in Active Directory</a></p>
<p>域环境搭建：</p>
<h1 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h1><p>在域环境中，攻击者有很多办法来获取域管理员权限。本篇文章将介绍几种当下流行的方法。本文描述的方法都是建立在攻击者已经获取了内网中一个域用户的权限。</p>
<p>对于很多企业有个不幸的事实：攻击者从域用户提升到域管理员往往不需要很多时间。防守方也会挺懵逼的：“？这是发生了什么”。</p>
<p>攻击者常常通过发送钓鱼邮件给一个或多个用户来获取代码在内网中的执行权限。一旦他们的代码在企业的内网中执行之后，第一步通常是信息收集，发现有用的资源来提高权限、维持权限及盗取信息。</p>
<p>尽管要介绍的方法细节不同，但大致分为以下几点：</p>
<ul>
<li>恶意软件注入（Spear-Phish、web漏洞利用等）</li>
</ul>
<p>（鱼叉式网络钓鱼（spear phishing）是面向特定组织的欺诈行为，目的是不通过授权访问机密数据。和用于常规钓鱼活动的电邮信息一样，鱼叉式网络钓鱼信息看上去来源可靠。钓鱼信息通常看上去是来自朋广泛群众基础的大型知名公司或网站，比如易趣或贝宝。但是在鱼叉式网络钓鱼事件中，电子邮件的显示来源可能是接收人公司内部的个人，且通常是地位比较高的人。）</p>
<ul>
<li>内网信息收集</li>
<li>窃取登陆凭证</li>
<li>漏洞利用与提权</li>
<li>拿到数据并传出内网</li>
<li>权限维持（植入后门）</li>
</ul>
<p>本文所讲的方法是从攻击者已经拿到内网权限开始。（本文主要是讲后渗透阶段的操作。）</p>
<p>通常对于攻击者来说从一般用户到本地管理员的提权也不是很难。这类提权可以通过利用一个未打补丁的提权漏洞来实现，或更常见的是在SYSVOL中查找本地管理员密码（例如组策略首选项）。</p>
<p>我在这两处多次提到过该技术：</p>
<ul>
<li><a href="https://adsecurity.org/?page_id=1352" target="_blank" rel="noopener">at several security conferences in 2015 (BSides, Shakacon, Black Hat, DEF CON, &amp; DerbyCon)</a>.</li>
<li>“<a href="https://adsecurity.org/?p=1684" target="_blank" rel="noopener">The Most Common Active Directory Security Issues and What You Can Do to Fix Them</a>“.</li>
</ul>
<p>接下来就是具体方法了：</p>
<h1 id="0x01-Passwords-in-SYSVOL-amp-Group-Policy-Preferences"><a href="#0x01-Passwords-in-SYSVOL-amp-Group-Policy-Preferences" class="headerlink" title="0x01. Passwords in SYSVOL &amp; Group Policy Preferences"></a>0x01. <strong>Passwords in SYSVOL &amp; Group Policy Preferences</strong></h1><p>1.SYSVOL和组策略首选项中的密码</p>
<h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p>这种方法是最简单的，因为它不需要任何的黑客工具。攻击者需要打开Windows任务管理器，搜索名为“SYSVOL DFS”的共享XML文件，通常这些文件会包含凭据：groups.xml, scheduledtasks.xml, &amp; Services.xml.</p>
<p>SYSVOL是在域中全域共享的，所有经认证的域用户都具有可读权限。SYSVOL包含登陆脚本、组策略数据和域控需要访问的其他域里的数据（因为SYSVOL里的数据自动被所有域控共享），所有的组策略都存储在这个位置：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">\&lt;DOMAIN&gt;SYSVOL&lt;DOMAIN&gt;Policies\</span><br></pre></td></tr></table></figure>

<p>在创建一个新的组策略时，会在SYSVOL中创建一个有相关配置数据的XML文件，如果提供了密码，则加密方式为AES-256.</p>
<p>2012年<a href="https://msdn.microsoft.com/en-us/library/2c15cbf0-f086-4c74-8b70-1f2fa45dd4be.aspx" target="_blank" rel="noopener">微软发布的AES加密的私钥</a>可用于解密它。由于任何经过身份验证的用户（任何域中用户和受信任域中用户）都具有SYSVOL的可读权限，因此他们可以在SYSVOL中查看包含AES加密密码的XML文件。一个示例文件如下：</p>
<p>（我是在自己搭建的域内重复了一遍设置配置组策略的操作，配置教程网上比较多。在组策略管理中的详细信息一栏中能够看到新建的用户id：）</p>
<img src="/pentest/adsecurity01/1.png" class="">

<p>因此，找到配置文件Groups.xml的具体路径为：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">\\neorah.me\SYSVOL\neorah.me\Policies\&#123;645BF091-0AB7-4E07-9E66-51CB3A40296B&#125;\User\Preferences\Groups</span><br></pre></td></tr></table></figure>

<img src="/pentest/adsecurity01/2.png" class="">

<p>攻击者在访问该XML文件后，可以使用AES私钥来解密文件中加密的GPP密码。也可以使用PowerSploit中的Get-GPPPassword功能来解密，类似工具测试如下图：</p>
<img src="/pentest/adsecurity01/3.png" class="">

<p>当然其他类型的文件也可能包含一些密码（通常是明文），如vbs和bat。</p>
<p>你可能认为通过打上一个防止管理员把信息放进组策略的方法就可以避免发生这种问题，但我在对客户进行安全评估时依然可以在SYSVOL中找到用户的密码。</p>
<h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><ul>
<li>在用于管理GPO的每台电脑上安装 KB2962486补丁，来防止将新凭据放在GPP中。</li>
<li>删除SYSVOL中包含密码的xml文件。</li>
<li>不要将密码保存在域用户能访问的文件中。</li>
</ul>
<p>关于这种攻击的更多信息： <a href="https://adsecurity.org/?p=2288" target="_blank" rel="noopener">Finding Passwords in SYSVOL &amp; Exploiting Group Policy Preferences.</a></p>
<h1 id="0x02-Exploit-the-MS14-068-Kerberos-Vulnerability-on-a-Domain-Controller-Missing-the-Patch"><a href="#0x02-Exploit-the-MS14-068-Kerberos-Vulnerability-on-a-Domain-Controller-Missing-the-Patch" class="headerlink" title="0x02. Exploit the MS14-068 Kerberos Vulnerability on a Domain Controller Missing the Patch"></a>0x02. Exploit the MS14-068 Kerberos Vulnerability on a Domain Controller Missing the Patch</h1><p>2.在未打补丁的域控制器上利用MS14-068关于Kerberos的漏洞进行攻击</p>
<h2 id="介绍-1"><a href="#介绍-1" class="headerlink" title="介绍"></a>介绍</h2><p>尽管从<a href="https://adsecurity.org/?p=525" target="_blank" rel="noopener">KB3011780补丁对MS14-068</a>进行修补已经过去一年多了（现在五年了），并且也有办法可以对MS14-068攻击进行检测和防御，但也并非所有的域控都会检测这个漏洞。大多数企业都在KB3011780发布的一个月后为域控装上了补丁，但无法确保新成为域控的服务器都对这个漏洞进行修复了。</p>
<p>感谢<a href="https://twitter.com/gmillard" target="_blank" rel="noopener">@Gavin Millard</a>，让我们可以简单的介绍这种攻击。</p>
<img src="/pentest/adsecurity01/4.png" class="">

<p>简单来说，攻击者可以利用MS14-068在5分钟内重写一个有效的Kerberos TGT身份验证使其成为域管理员（或目录林管理员）。如上图所示，就像采取了有效的登机密码，并且登机牌上还写着”飞行员”，然后持有这张登机牌的用户就会被安排到驾驶仓，并且还会提供咖啡。</p>
<p>在补丁发布的两周后，MS14-068漏洞利用的exp首次公布。该exp由Sylvain Monné (@BiDOrD)编写，名为PyKEK。<a href="https://github.com/mubix/pykek" target="_blank" rel="noopener">PyKEK</a>是python脚本，可以运行在与未打补丁的DC通信的任何具有python环境的平台上，得到一个ccache文件。取出这个ccache文件，然后利用Mimikatz将TGT注入内存，就可以拿到一个被当作管理员的票据了。使用这张票据，攻击者就可以访问域控上的admin$共享了。</p>
<h2 id="复现"><a href="#复现" class="headerlink" title="复现"></a>复现</h2><h3 id="测试环境"><a href="#测试环境" class="headerlink" title="测试环境"></a>测试环境</h3><p>我用虚拟机搭了两台win机器：Win7和Win2003。</p>
<p>Win2003作为域控，主机名为DC。域为neorah.me。</p>
<p>Win7作为普通域用户加入域中，其中有两个用户：域用户和本地用户。</p>
<p>其中域用户名及密码：zhangxue\abc123-（之前搭的环境了，nc一直忘记把名字改过来了复现完了才发现呜呜，就这样吧）</p>
<p>本地用户名及密码：test/123456</p>
<p>本次测试的目的：已经拿到win7域用户的权限，将这个普通域用户权限提升为域控权限（可以直接通过<code>net use \\DC.neorah.me\c$</code>获取域控的资源）</p>
<h3 id="测试步骤"><a href="#测试步骤" class="headerlink" title="测试步骤"></a>测试步骤</h3><p>首先用域用户登陆Win7，得到域账户的SID：</p>
<img src="/pentest/adsecurity01/5.png" class="">

<p>再以本地账户登陆，运行PyKek:</p>
<img src="/pentest/adsecurity01/6.png" class="">

<p>可以看到在同目录下生成了TGT文件：</p>
<img src="/pentest/adsecurity01/7.png" class="">

<p>利用mimikatz工具将得到的<code>TGT_zhangxue@neorah.me.ccache</code>写入内存，创建证书：</p>
<img src="/pentest/adsecurity01/8.png" class="">

<p>利用klist命令查看到使用mimikatz创建缓存证书前后的区别：</p>
<p>创建前：（我也搞不懂为什么每个汉字会出现两次…太怪了 不过不影响）</p>
<img src="/pentest/adsecurity01/9.png" class="">

<p>创建后：</p>
<img src="/pentest/adsecurity01/10.png" class="">

<p>测试目的是希望能够提高权限，获取到域控的网络资源，现在可以试试：</p>
<img src="/pentest/adsecurity01/11.png" class="">

<img src="/pentest/adsecurity01/12.png" class="">

<p><strong>针对此脚本的解决方案：</strong></p>
<p>打补丁，或者域控使用Win2012/2012R2。</p>
<h2 id="MS14-068利用过程"><a href="#MS14-068利用过程" class="headerlink" title="MS14-068利用过程"></a>MS14-068利用过程</h2><ul>
<li><p>普通用户发送一个不包含PAC(Privilege Attribute Certificate 特权属性证书)的kerberos TGT 认证请求，然后域控会回复TGT。</p>
</li>
<li><p>伪造一个没有密钥的PAC，由于没有密钥，生成的PAC是将域用户的密码数据使用md5加密而不是HMAC_MD5签名。</p>
</li>
<li><p>将PAC-less的TGT以及作为TGS服务认证请求数据的一部分的伪造PAC发送给域控。</p>
</li>
<li><p>域控被发送过来的数据迷惑了，它丢弃了用户发过来的这个PAC-less的TGT，同时创建一个新的TGT，并将伪造的PAC插入自己的授权数据中，并将该TGT发送给用户。</p>
</li>
<li><p>通过伪造PAC的TGT使用户成为域管理员。</p>
</li>
</ul>
<p>Mimikatz的作者Benjamin Delpy通过改进PyKEK写了一个新的MS14-068 exp：<a href="https://github.com/gentilkiwi/kekeo" target="_blank" rel="noopener">Kekeo</a>。这个exp可以发现并且定位存在漏洞的域控，并且无论是打了补丁的DC还是使用了Win2012/2012R2的DC，这个工具都可以工作。这个Exp使用的利用路径与PyKEK是相同的，但在最后加了一个新的步骤：可以产生一个对任何内网的域控都可以进行访问的TGT。这样就可以在域的任何一处地方执行exp，得到域管权限。</p>
<img src="/pentest/adsecurity01/13.png" class="">

<h2 id="解决方案-1"><a href="#解决方案-1" class="headerlink" title="解决方案"></a>解决方案</h2><ul>
<li>确保在运行DCPromo进程前有一个KB3011780补丁查询步骤：利用Powershell命令<code>get-hotfix 3011780</code>进行快速检查。</li>
<li>设置自动更新补丁。</li>
</ul>
<h1 id="0x03-Kerberos-TGS-Service-Ticket-Offline-Cracking-Kerberoast"><a href="#0x03-Kerberos-TGS-Service-Ticket-Offline-Cracking-Kerberoast" class="headerlink" title="0x03. Kerberos TGS Service Ticket Offline Cracking (Kerberoast)"></a><strong>0x03. Kerberos TGS Service Ticket Offline Cracking (Kerberoast)</strong></h1><p>3.kerberos TGS服务凭证离线爆破（Kerberoast）</p>
<h2 id="介绍-2"><a href="#介绍-2" class="headerlink" title="介绍"></a>介绍</h2><p>这种攻击方法在开头给出的文章中也有较为清晰的解释。</p>
<p>Kerberoast是一种无需将任何数据包发送到目标系统，就能够使普通用户从AD中提取服务帐户凭证的有效办法。正因为人们喜欢创建弱密码，因此这种攻击方法比较有效。攻击成功的原因是：大多数服务帐户密码与域成员密码长度相同（通常为10到12位），这意味着即便是暴力破解花费的时间也不会长于密码到期时间，并且大多数服务帐户密码也没用被设置到期，因此相同的密码有效期可能达数月甚至数年。此外，大多数服务帐户的权限都很高，一般都是域管理员权限，能够完整的对AD进行操作。</p>
<p>注意：当目标服务是windows的系统管理服务时此攻击不能成功，因为这些服务会映射到AD的计算机帐户中，该帐户会产生128位的密码，所以很难被爆破出来。</p>
<p>这种攻击方法的内容为目标帐户的服务主体名称（SPN）请求一个Kerberos服务凭证（TGS）。</p>
<p>该请求使用一个有效的域用户凭证（TGT）为服务器上面运行的目标服务请求一个或者多个服务凭证。域控一般不会确认这个用户是不是已经连接到这些资源（甚至不确认它是否有权限访问）。它会先在AD中查找SPN，并使用与SPN相关联的服务帐户对凭证进行加密，以便于服务验证用户的访问权限。（这个过程中在开头的文章中有解释）</p>
<p>请求的Kerberos服务凭证加密类型为<code>RC4_HMAC_MD5</code>，因此服务帐户的NTLM密码用于了加密服务凭证。这也就意味着Kerberoast可以尝试通过不同的NTLM散列来解密Kerberos凭证，并且在成功解密票证后，会得到正确的服务帐户密码。</p>
<p>注意：此处无需提升权限即可获得服务票证，也不会向目标发送任何流量。</p>
<p>Tim Medin在 DerbyCon 2014上发表了他的“攻击微软Kerberosd的想法”演示文稿（[幻灯片](<a href="https://files.sans.org/summit/hackfest2014/PDFs/Kicking" target="_blank" rel="noopener">https://files.sans.org/summit/hackfest2014/PDFs/Kicking</a> the Guard Dog of Hades - Attacking Microsoft Kerberos  - Tim Medin(1).pdf)和<a href="https://www.youtube.com/watch?v=PUyhlN-E5MU&feature=youtu.be" target="_blank" rel="noopener">视频</a>），以及发布了<a href="https://github.com/nidem/kerberoast" target="_blank" rel="noopener">Kerberoast</a>。</p>
<h2 id="复现-1"><a href="#复现-1" class="headerlink" title="复现"></a>复现</h2><h3 id="实验环境"><a href="#实验环境" class="headerlink" title="实验环境"></a>实验环境</h3><p>域：neorah.me</p>
<p>域控：winserver2012</p>
<p>域内主机1：win7</p>
<p>域内主机2：winserver2008 有Mssql服务</p>
<h3 id="实验目标"><a href="#实验目标" class="headerlink" title="实验目标"></a>实验目标</h3><p>在拿到域内主机win7的权限后，请求域内主机2的TGS，能够根据导出的票据爆破处服务帐户密码。</p>
<h3 id="实验步骤"><a href="#实验步骤" class="headerlink" title="实验步骤"></a>实验步骤</h3><h4 id="注册SPN"><a href="#注册SPN" class="headerlink" title="注册SPN"></a>注册SPN</h4><p>先设置请求的Kerberos服务凭证加密类型，设为<code>RC4_HMAC_MD5</code></p>
<img src="/pentest/adsecurity01/14.png" class="">

<p>由于该方法要实现的条件为：该SPN要注册在域用户帐户（Users）下，并且此域用户需要具有域管理员权限。</p>
<p>因此我们需要以域用户帐户注册SPN</p>
<p>用<code>Setspn -S SQLServer/sql.neorah.me mssqluser</code>将SQLServer进行SPN服务注册</p>
<p>其中，sql为主机名，mssqluser为域用户用户名。</p>
<img src="/pentest/adsecurity01/16.png" class="">

<h4 id="获取有价值的SPN"><a href="#获取有价值的SPN" class="headerlink" title="获取有价值的SPN"></a>获取有价值的SPN</h4><p>用<code>setspn -q */*</code>查看当前域内所有的SPN</p>
<img src="/pentest/adsecurity01/17.png" class="">

<p>能够查询到刚才用mssqluser注册的SPN</p>
<p>用<a href="https://github.com/nidem/kerberoast" target="_blank" rel="noopener">Kerberoast</a>工具包中的 GetUserSPNs.ps1查询到域内用户注册的SPN</p>
<img src="/pentest/adsecurity01/18.png" class="">

<h4 id="请求TGS"><a href="#请求TGS" class="headerlink" title="请求TGS"></a>请求TGS</h4><ul>
<li><p>请求指定TGS</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Add-Type -AssemblyName System.IdentityModel</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">New-Object System.IdentityModel.Tokens.KerberosRequestorSecurityToken -ArgumentList &quot;SQLServer&#x2F;sql.neorah.me&quot;</span><br></pre></td></tr></table></figure>
</li>
<li><p>请求所有TGS：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Add-Type -AssemblyName System.IdentityModel</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">setspn.exe -q *&#x2F;* | Select-String &#39;^CN&#39; -Context 0,1 | % &#123; New-Object System. IdentityModel.Tokens.KerberosRequestorSecurityToken -ArgumentList $_.Context.PostContext[0].Trim() &#125;</span><br></pre></td></tr></table></figure>



</li>
</ul>
<p>Kerberos 协议中请求的票据会保存在内存中，可以通过 <code>klist</code> 命令查看当前会话存储的 kerberos 票据</p>
<p>接着用mimikatz导出票据</p>
<p><code>kerberos::list /export</code></p>
<img src="/pentest/adsecurity01/15.png" class="">

<h4 id="破解"><a href="#破解" class="headerlink" title="破解"></a>破解</h4><p>用kerberoast里的tgsrepcrack.py破解即可。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">.&#x2F;tgsrepcrack.py wordlist.txt 1-40a10000-test@SQLServer~sql.neorah.me-NEORAH.ME.kirbi</span><br></pre></td></tr></table></figure>

<p>我环境的python有点问题一直报错…整了好一会没成功 先看其他方法吧</p>
<h2 id="解决方案-2"><a href="#解决方案-2" class="headerlink" title="解决方案"></a>解决方案</h2><ul>
<li>最有效的办法是确保服务帐户密码长度大于25个字符。</li>
<li>为了确保帐户密码长、复杂且能够定期修改，可以使用托管或组托管服务帐户。</li>
<li>可以使用第三方产品来存储密码。</li>
</ul>
<p>关于此种攻击的更多信息可以在此处获取: <a href="https://adsecurity.org/?p=2293" target="_blank" rel="noopener">Cracking Kerberos TGS Tickets Using Kerberoast – Exploiting Kerberos to Compromise the Active Directory Domain</a>.</p>
<p>这两篇文章介绍了检测潜在的Kerberoast信息： “<a href="https://adsecurity.org/?p=3458" target="_blank" rel="noopener">Detecting Kerberoasting Activity</a>” and “<a href="https://adsecurity.org/?p=3513" target="_blank" rel="noopener">Detecting Kerberoasting Activity Part 2 – Creating a Kerberoast Service Account Honeypot</a>”</p>
<h1 id="0x04-The-Credential-Theft-Shuffle"><a href="#0x04-The-Credential-Theft-Shuffle" class="headerlink" title="0x04. The Credential Theft Shuffle"></a>0x04. <strong>The Credential Theft Shuffle</strong></h1><p>4.悄无声息的盗窃凭证</p>
<h2 id="介绍-3"><a href="#介绍-3" class="headerlink" title="介绍"></a>介绍</h2><p>我称这部分为“The Credential Theft Shuffle”，因为很难简单的将这种技巧描述出来。将它看成一次舞台演出。</p>
<p>大致的步骤为：拿下一台机器，提权，导出凭据。然后使用凭据进入其他主机，再进行提权并导出，横向渗透到更多机器上。</p>
<p>由于大多数AD管理员会将账户登录到他们的主机上面，然后使用RunAs（将其管理员凭据放在本地使用的命令）或者RDP命令连接到远程服务端，因此这种攻击方法得到域管理员凭证会很迅速。</p>
<p>步骤一：先拿下一台机器进行提权，然后使用mimikats等工具导出本地用户信息，得到最近登陆账户及密码。</p>
<p>步骤二：使用刚才收集的管理员信息来尝试着登陆其他具有管理员权限的机器。因为本地的管理员账户很难被正确设置(现在你可以使用微软的LAPS进行配置)，因此一般是会成功的。如果你知道了一组管理员的帐号密码，就相当于知道了多个甚至全部主机的账户和密码，这就意味着你有了所有主机的管理员权限。当你连接到其他主机后，试着以同样的方法对这些主机进行本地登录信息的导出，直到得到域管理员的账户信息。并且，使用本地用户进行登录是一个很隐蔽的方法，这样不需要登录到域控上面，也很少有主机发送安全日志到中央日志记录系统当中（SIEM）。</p>
<p>步骤三：利用被盗取的账户信息收集更多信息。比如运行应用的服务器中往往具有大量用户信息（更有可能含有域管理员信息）。比如：CAS、OWA、MSSQL、RDP等服务器。</p>
<p>步骤四：达成目的！</p>
<p>得到了Domain Admin凭据后，攻击者就可以毫无阻碍的<a href="https://adsecurity.org/?p=1729" target="_blank" rel="noopener">得到域中所有用户信息</a>。</p>
<p><strong>注意：</strong></p>
<ul>
<li><p>使用Domain Admin帐户登录到计算机会将凭据放在LSASS（受保护的内存空间）中。 对此计算机具有管理员权限（或本地System）的人可以从LSASS中导出凭据，并且可以重新使用。</p>
</li>
<li><p>使用用户帐户登录计算机，然后使用RunAs输入Domain Admin凭据，将凭据放置在LSASS（受保护的内存空间）中。 对此计算机具有管理员权限（或本地System）的人可以从LSASS中转储凭据，并且可以重新使用这些凭据。</p>
</li>
<li><p>使用用户帐户登录计算机并通过在RDP凭据窗口中输入Domain Admin凭据打开与服务器的RDP会话，将向所有在系统上运行键盘记录程序的人（可能是以前的攻击者）公开Domain Admin凭据。</p>
</li>
<li><p>如果有服务部署到具有Domain Admin权限的服务帐户的上下文中运行的所有工作站或所有服务器（或两者），则只需破坏单个系统即可破坏整个Active Directory域。 当服务以显式凭据启动时，会将凭据加载到LSASS中，以使服务在这些凭据的上下文中运行。 对此计算机具有管理员权限（或本地System）的人可以从LSASS中转储凭据，并且可以重新使用这些凭据。</p>
</li>
</ul>
<p>通常PowerShell是一种很好的管理方法，因为通过PowerShell连接到远程系统是一种网络登录（没有凭据存储在远程系统的内存中）。这是一种理想的选择，并且微软也在通过管理员模式将RDP转变。有一种方法可以通过PowerShell连接到远程系统，并能够通过CredSSP使用凭据。但问题是CredSSP不太安全。</p>
<p><a href="http://www.powershellmagazine.com/2014/03/06/accidental-sabotage-beware-of-credssp/" target="_blank" rel="noopener">Joe Bialek在这里写道</a>:</p>
<p>管理员在使用PowerShell远程处理时面临的一个常见问题是“双跳”问题。管理员使用PowerShell远程处理连接到服务器A，然后尝试从服务器A连接到服务器B。不幸的是，第二个连接失败了。<br>原因是在默认情况下，PowerShell在远程登录时会使用“网络登录”进行身份验证。网络登录通过向远程服务器证明您拥有用户凭据而不向该服务器发送凭证（参见<a href="http://msdn.microsoft.com/en-us/library/windows/desktop/aa378747(v=vs.85).aspx" target="_blank" rel="noopener">Kerberos</a>和<a href="http://msdn.microsoft.com/en-us/library/windows/desktop/aa378749(v=vs.85).aspx" target="_blank" rel="noopener">NTLM</a>身份验证）。由于远程服务器没有您的凭据，当您尝试进行第二跳（从服务器A到服务器B）时就会失败，因为服务器A没有用于向服务器B进行身份验证的凭据。</p>
<p>为解决此问题，PowerShell提供了CredSSP（凭据安全支持提供程序）选项。使用CredSSP时，PowerShell将执行“网络明文登录”而不是“网络登录”。网络明文登录将用户的明文密码发送到远程服务器。使用CredSSP时，将向服务器A发送用户的明文密码，因此就可以向服务器B进行身份验证。双跳就成功了。</p>
<p>更新：这次实验是在Windows2012上进行的，微软已经在WIN server2012R2以及win8.1上做出了更改，不会将明文密码存储在内存里面。这就意味着攻击者即使运行Mimikatz也不会得到明文密码，但是攻击者还是可以看到你的NT密码的hash值以及你的Kerberos TGT，这两者与得到密码相比，都是一样的。都可用于网络身份验证。</p>
<p>此外，即使您的明文凭据未保存在内存中，仍会发送到远程服务器。攻击者可以在本地安全机构子系统服务（LSASS.exe）中注入恶意代码，并在传输过程中拦截您的密码。所以尽管你可能不会再看到你的密码了，攻击者仍然可以恢复您的密码。</p>
<p><strong>所以，请不要使用CredSSP。</strong></p>
<p>类似的一个漏洞是在Powershell远程连接中使用的WinRM中的一个配置问题，这个配置叫做：<a href="http://blogs.msdn.com/b/powershell/archive/2015/10/27/compromising-yourself-with-winrm-s-allowunencrypted-true.aspx" target="_blank" rel="noopener">“AllowUnencrypted”</a>。将此值改为”True”,就会禁用通过这个系统的任何WinRM通信的加密，使用明文传输。包括Powershell远程连接。</p>
<h1 id="0x05-Pass-the-hash-evolves-into-Pass-the-Credential"><a href="#0x05-Pass-the-hash-evolves-into-Pass-the-Credential" class="headerlink" title="0x05. Pass the hash evolves into Pass-the-Credential"></a>0x05. <strong>Pass the hash evolves into Pass-the-Credential</strong></h1><p>哈希传递攻击到凭证传递攻击</p>
<h2 id="介绍-4"><a href="#介绍-4" class="headerlink" title="介绍"></a>介绍</h2><p>大部分人都听说过hash传递攻击（PtH），它是通过找到用户密码的hash值来进行攻击的（通常是NTLM密码hash），使用PtH进行攻击有趣的地方是，他不需要知道明文密码到底是什么，因为在windows的网络通信中，Hash就是用来对用户身份进行验证的。微软的产品和工具显然不支持哈希传递攻击的，因此需要用到第三方工具Mimikatz等。</p>
<p>一旦发现密码Hash，Hash传递攻击就能为攻击者提供了很多途径，但还有其他选择。</p>
<p>凭证传递攻击（PtH）通过收集已经存在的kerberos凭证来进行用户验证。 Mimikatz支持为当前通过系统身份验证的每个用户收集当前用户的Kerberos票证或所有Kerberos票证（如果配置了Kerberos不受约束的委派，这可能很重要）。 获取了Kerberos票证后便可以使用Mimikatz传递，并将其用于访问资源（在Kerberos票证的生存期内）。</p>
<p>超hash传递攻击（OverPass-the-Hash）又名密钥传递攻击。它涉及使用获取的密码哈希来获取Kerberos凭证。此技术为当前用户清除所有现有的Kerberos密钥（哈希），并将获取的哈希值注入到内存中以用于Kerberos票证请求。下次需要Kerberos票证进行资源访问时，将使用注入的散列（现在是内存中的Kerberos密钥）来请求Kerberos凭证。<a href="https://adsecurity.org/?page_id=1821#SEKURLSAPth" target="_blank" rel="noopener">Mimikatz提供执行OverPass-the-Hash的功能</a>。因为存在检测PtH的方法，因此这种此种方法是相对来说比较好的。</p>
<p><strong>注意</strong>：如果获取的哈希为NTLM，则Kerberos票证为RC4。 如果哈希为AES，则Kerberos票证将使用AES。</p>
<p>以下是主要的凭证盗窃的其他方式：</p>
<ul>
<li>Pass-the-Hash：抓取哈希并访问资源。在用户更改帐户密码之前哈希才有效。</li>
<li>Pass-the-Ticket：获取Kerberos机票并用于访问资源。票证有效期至票证生效期满（通常为7天）。</li>
<li>OverPass-the-Hash：使用密码哈希来获取Kerberos票证。用户更改帐户密码之前，哈希有效。</li>
</ul>
<h2 id="解决方案-3"><a href="#解决方案-3" class="headerlink" title="解决方案"></a>解决方案</h2><ul>
<li><p><a href="https://technet.microsoft.com/en-us/library/mt634654.aspx" target="_blank" rel="noopener">管理员应具有用于管理活动的单独的管理工作站</a>(链接失效了qaq)。永远不要将管理员帐户登录到执行用户活动（例如电子邮件和Web浏览）的常规工作站上。这大大减小了被盗取凭证的机会。注意，智能卡（<em>Smart Card</em>）不能阻止用户信息泄漏，因为在访问智能卡时仍会用到账户对应的hash值。这些哈希在后台用于资源访问。智能卡仅确保对系统进行身份验证的用户才能拥有。一旦用于对系统进行身份验证，智能卡的双因素身份验证（2fA）就会成为使用帐户密码的一个因素，也就是用户密码的hash值。此外，一旦为智能卡身份验证配置了帐户，系统就会为该帐户生成一个新密码（并且永远不会更改）。</p>
</li>
<li><p>使用Microsoft LAPS之类的产品，工作站和服务器上的所有本地管理员帐户密码都应长，复杂且随机。</p>
</li>
<li><p>配置组策略以防止本地管理员帐户通过网络进行身份验证。以下示例GPO阻止本地帐户通过网络（包括RDP）登录，并且阻止域管理员和目录林管理员登录。 GPO包括以下设置：</p>
<ul>
<li><p>拒绝以下用户从网络访问此计算机：local account, Enterprise Admins, Domain Admins</p>
</li>
<li><p>拒绝通过远程桌面登录：local account, Enterprise Admins, Domain Admins</p>
</li>
<li><p>拒绝本地登录：Enterprise Admins, Domain Admins</p>
</li>
</ul>
</li>
</ul>
<img src="/pentest/adsecurity01/19.png" class="">

<p><strong>注意：</strong>首次应使用服务器配置进行测试，因为它会破坏某些“特殊”情况（例如群集）。</p>
<h1 id="0x06-Gain-Access-to-the-Active-Directory-Database-File-ntds-dit"><a href="#0x06-Gain-Access-to-the-Active-Directory-Database-File-ntds-dit" class="headerlink" title="0x06. Gain Access to the Active Directory Database File (ntds.dit)"></a>0x06. <strong>Gain Access to the Active Directory Database File (ntds.dit)</strong></h1><p>6.获取Active Directory数据库文件（ntds.dit）的访问权限</p>
<h2 id="介绍-5"><a href="#介绍-5" class="headerlink" title="介绍"></a>介绍</h2><p>Active Directory数据库（ntds.dit）包含有关Active Directory域中所有对象的信息，此数据库中的数据将复制到域中的所有域控制器中，该文件还包含所有域用户和计算机帐户的密码哈希值，域控上的ntds.dit文件只能由可以登录到DC的用户访问。显然，保护这个文件是至关重要的，因为攻击者访问这个文件会导致整个域沦陷.</p>
<p>这是用于获取NTDS.dit数据而无需成为域管理员的方法（不太全面）：</p>
<ol>
<li><p>备份位置（备份服务器存储，媒体或网络共享）</p>
<p>攻击者使用备份共享中的ntds.dit文件访问域控备份并且安装后门。确保存储域控备份的任何网络位置已经被保护。只有域管理员才能访问它们。</p>
</li>
<li><p>在升级到域控制器之前，找到在成员服务器上暂存的NTDS.dit文件。</p>
<p>IFM与DCPromo使用的“从介质安装”的方式，因此要升级的服务器不需要通过网络从另一个DC复制域数据。 IFM集是NTDS.dit文件的副本，可以在共享上暂存以升级新的DC，也可能在尚未被提升为域控的服务器上找到，并且此服务器没有受到正确的保护。</p>
</li>
<li><p>凭借对虚拟化主机的管理员权限，可以克隆虚拟DC，并离线复制相关数据。</p>
<p>获得对虚拟DC存储数据的访问权并访问域凭据。 您运行VMWare吗？ VCenter管理员是完全管理员。 所以使用VCenter Admin权限可以克隆域控并将数据复制到本地硬盘。</p>
<p>当虚拟机挂起时，也可以从VM内存中提取LSASS数据。不要低估虚拟管理员对虚拟域控制器的影响。如果你的VCenter管理员组是在域控当中，那么你需要尽快改变这一设置。将权限委派给适当的组，不要通过服务器管理员帐户为攻击者提供后门攻击域控的能力。</p>
<p><strong>您的虚拟管理员需要成为域管理员（当拥有虚拟DC时）。</strong></p>
</li>
<li><p>攻击有权登录到域控的帐户。</p>
<p>Active Directory中有多个组，大多数组都不应该具有对域控制器的默认登录权限。</p>
<p>以下组默认能够登录到域控制器：</p>
<ul>
<li>Enterprise Admins (目录林管理员组)</li>
<li>Domain Admins（域管理员组）</li>
<li>Administrators（管理员组）</li>
<li>Backup Operators（备份操作成员）</li>
<li>Account Operators（账户管理组）</li>
<li>Print Operators（打印机操作组）</li>
</ul>
<img src="/pentest/adsecurity01/20.png" class="">

</li>
</ol>
<p>这意味着，如果攻击者破坏了帐户操作员或打印操作员中的帐户，则Active Directory域可能会受到攻击，因为这些组对域控制器具有登录权限。</p>
<h2 id="解决方案-4"><a href="#解决方案-4" class="headerlink" title="解决方案"></a>解决方案</h2><ul>
<li>限制有权登录到域控制器的组/帐户。</li>
<li>限制具有完整活动目录权限的组/帐户，特别是服务帐户。</li>
<li>保护活动目录数据库的每一个副本，并且不要将它放在比域控信任级别低的主机上面。</li>
</ul>
<h2 id="复现-2"><a href="#复现-2" class="headerlink" title="复现"></a>复现</h2><p>那么，当一个帐户具有域控制器的登录权限会怎么样？</p>
<p>如果是域控，那当然是<a href="https://adsecurity.org/?p=2398" target="_blank" rel="noopener">先把所有的登录凭证全部获取到本地</a>。</p>
<ol>
<li><p>首先使用Mimikatz获取所有登录信息：</p>
<p>Mimikatz可以从域控上面抓取到所有账户信息：<code>lsadump::lsa /inject</code></p>
<img src="/pentest/adsecurity01/21.png" class="">
</li>
<li><p>使用Mimikatz转储LSASS内存（获取域管理员凭据）</p>
<p>Mimikatz可用于转储LSASS，然后从不同系统上的LSASS.dmp文件中提取登录凭据。在域控制器上，这经常会导致得到域管理员凭据。</p>
<p>这里需要先转存出lsass.dump文件:</p>
<p>对于NT6可以直接使用windows中的任务管理器进行dump：</p>
<p>任务管理器-进程-显示所有用户进程—找到lsass—右键“创建转储文件”</p>
<img src="/pentest/adsecurity01/22.png" class="">

<p>对于NT5可以使用微软的<a href="http://technet.microsoft.com/en-us/sysinternals/dd996900.aspx" target="_blank" rel="noopener">Procdump</a>工具。</p>
<p>转存出来后执行Mimikataz执行命令：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sekurlsa::minidump lsass.dmp</span><br><span class="line">sekurlsa::logonPasswords full</span><br></pre></td></tr></table></figure>

<img src="/pentest/adsecurity01/23.png" class="">

<p>读出明文密码。</p>
</li>
<li><p>用NTDSUtil创建媒体安装集IFM（用于抓取NTDS.dit文件）<br>NTDSUtil是用于本机处理AD数据库（ntds.dit）的命令实用程序，并为允许为DCPromo准备IFM集。IFM是用于DCPromo命令中”从介质安装”这一过程的，因此要升级的服务器不需要通过网络从另一个DC复制域数据。IFM集是在此实例中<code>C:\ temp</code>中创建的NTDS.dit文件的副本。</p>
<p>该文件可能会在新域控上进行共享，或者可能在尚未升级成域控的新服务器上找到该文件。这样的服务器可能未正确保护。</p>
<img src="/pentest/adsecurity01/24.png" class="">
</li>
<li><p>从NTDS.dit文件（和注册表系统配置单元）中转储活动目录域凭据。</p>
<p>一旦攻击者获得NTDS.dit文件的副本（以及用于解密数据库文件的某些注册表项），就可以提取Active Directory数据库文件中的凭据数据。</p>
<p>一旦攻击者从注册表和NTDS.dit文件中获取系统配置文件，他们就能拥有所有管理员凭据。这个截图来自一个安装了Impacket python工具的Kali。使用Impacket中的secretsdump.py python脚本转储DIT。</p>
<p>（这个截图是搬运了原文章的…因为环境没配好5555）</p>
<img src="/pentest/adsecurity01/25.png" class="">

</li>
</ol>
<p>截至2015年10月，还有一种Windows方法:<a href="https://www.dsinternals.com/en/dumping-ntds-dit-files-using-powershell/" target="_blank" rel="noopener">利用PowerShell方法从DSInternals.com中的NTDS.dit文件（和注册表系统配置单元）中转储凭据，名为Get-ADDBAccount</a>（尽管它仅适用于Windows 8和Windows Server 2012及更高版本）</p>
<p>一旦攻击者转储了域数据库，就有很多选择来提权和维持权限，包括<a href="https://adsecurity.org/?p=1640" target="_blank" rel="noopener">创建和使用Golden Tickets，从拿下单个域到控制整个目录群</a>。</p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><h2 id="本文参考"><a href="#本文参考" class="headerlink" title="本文参考"></a>本文参考</h2><ul>
<li><a href="https://adsecurity.org/?page_id=1352" target="_blank" rel="noopener">Sean Metcalf’s Presentations on Active Directory Security</a></li>
<li><a href="https://adsecurity.org/?page_id=1821" target="_blank" rel="noopener">Mimikatz Guide and Command Reference</a></li>
<li><a href="https://adsecurity.org/?p=1684" target="_blank" rel="noopener">The Most Common Active Directory Security Issues and What You Can Do to Fix Them</a></li>
<li><a href="https://adsecurity.org/?p=2288" target="_blank" rel="noopener">Finding Passwords in SYSVOL &amp; Exploiting Group Policy Preferences</a></li>
<li><a href="https://adsecurity.org/?tag=ms14068" target="_blank" rel="noopener">MS14-068 Vulnerability, Exploitation, and Exploit Detection</a></li>
<li><a href="https://adsecurity.org/?p=2293" target="_blank" rel="noopener">Cracking Kerberos TGS Tickets Using Kerberoast – Exploiting Kerberos to Compromise the Active Directory Domain</a>.</li>
<li><a href="https://adsecurity.org/?p=2398" target="_blank" rel="noopener">How Attackers Dump Active Directory Database Credentials</a></li>
<li><a href="https://adsecurity.org/?p=384" target="_blank" rel="noopener">Using Group Policy Preferences for Password Management = Bad Idea</a></li>
<li><a href="https://adsecurity.org/?p=1929" target="_blank" rel="noopener">Sneaky Active Directory Persistence Tricks</a></li>
<li><a href="https://adsecurity.org/?p=1640" target="_blank" rel="noopener">Golden Tickets which can be used to exploit the entire forest based on the compromise of a single domain</a></li>
<li>The PowerSploit function <a href="https://github.com/PowerShellMafia/PowerSploit/blob/master/Exfiltration/Get-GPPPassword.ps1" target="_blank" rel="noopener">Get-GPPPassword</a></li>
<li><a href="https://adsecurity.org/?p=63" target="_blank" rel="noopener">Group Policy Preferences Password Vulnerability Now Patched</a></li>
<li><a href="https://adsecurity.org/?p=1790" target="_blank" rel="noopener">Microsoft Local Administrator Password Solution (LAPS)</a></li>
<li>Tim Medin’s DerbyCon “Attacking Microsoft Kerberos Kicking the Guard Dog of Hades” presentation in 2014 ([slides](<a href="https://files.sans.org/summit/hackfest2014/PDFs/Kicking" target="_blank" rel="noopener">https://files.sans.org/summit/hackfest2014/PDFs/Kicking</a> the Guard Dog of Hades - Attacking Microsoft Kerberos  - Tim Medin(1).pdf) &amp; <a href="https://www.youtube.com/watch?v=PUyhlN-E5MU&feature=youtu.be" target="_blank" rel="noopener">video</a>) where he released the <a href="https://github.com/nidem/kerberoast" target="_blank" rel="noopener">Kerberoast Python TGS cracker</a>.</li>
</ul>
<h2 id="翻译及复现参考"><a href="#翻译及复现参考" class="headerlink" title="翻译及复现参考"></a>翻译及复现参考</h2><ul>
<li><p><a href="https://beta.4hou.com/technology/4256.html" target="_blank" rel="noopener">https://beta.4hou.com/technology/4256.html</a></p>
</li>
<li><p><a href="https://www.anquanke.com/post/id/171552" target="_blank" rel="noopener">https://www.anquanke.com/post/id/171552</a></p>
</li>
<li><p><a href="https://3gstudent.github.io/%E5%9F%9F%E6%B8%97%E9%80%8F-Kerberoasting/" target="_blank" rel="noopener">https://3gstudent.github.io/%E5%9F%9F%E6%B8%97%E9%80%8F-Kerberoasting/</a></p>
</li>
<li><p><a href="https://www.163.com/dy/article/FC4RFSLI05372NE2.html" target="_blank" rel="noopener">https://www.163.com/dy/article/FC4RFSLI05372NE2.html</a></p>
</li>
</ul>
<p>终于完结了qaq，之前都是这里学一点那里学一点的，这篇文章及其扩展内容写的真的很详细！不仅学到了很多，翻译能力还提升了不少，太棒啦。</p>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">Neorah</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="https://neorah.me/pentest/adsecurity01/">https://neorah.me/pentest/adsecurity01/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/" target="_blank" rel="noopener">CC BY-NC-SA 3.0</a> unless stating additionally.</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E5%9F%9F%E6%B8%97%E9%80%8F/">域渗透</a></div><nav id="pagination"><div class="prev-post pull-left"><a href="/pentest/%E5%86%85%E7%BD%91%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86/"><i class="fa fa-chevron-left">  </i><span>内网信息收集</span></a></div><div class="next-post pull-right"><a href="/ctf/xiangyunctf/"><span>祥云杯2020web Writeup</span><i class="fa fa-chevron-right"></i></a></div></nav></div></div><footer class="footer-bg" style="background-image: url(/img/top.JPG)"><div class="layout" id="footer"><div class="copyright">&copy;2020 - 2021 By Neorah</div><div class="footer_custom_text">Theme By melody</div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file-o"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="/js/third-party/anime.min.js"></script><script src="/js/third-party/jquery.min.js"></script><script src="/js/third-party/jquery.fancybox.min.js"></script><script src="/js/third-party/velocity.min.js"></script><script src="/js/third-party/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.7.0"></script><script src="/js/fancybox.js?version=1.7.0"></script><script src="/js/sidebar.js?version=1.7.0"></script><script src="/js/copy.js?version=1.7.0"></script><script src="/js/fireworks.js?version=1.7.0"></script><script src="/js/transition.js?version=1.7.0"></script><script src="/js/scroll.js?version=1.7.0"></script><script src="/js/head.js?version=1.7.0"></script><script src="/js/search/algolia.js"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script><div class="search-dialog" id="algolia-search"><div class="search-dialog__title" id="algolia-search-title">Algolia</div><div id="algolia-input-panel"><div id="algolia-search-input"></div></div><hr><div id="algolia-search-results"><div id="algolia-hits"></div><div id="algolia-pagination"></div><div id="algolia-stats"></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div></body></html>