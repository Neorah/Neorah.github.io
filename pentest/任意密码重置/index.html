<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="任意密码重置漏洞"><meta name="keywords" content=""><meta name="author" content="Neorah"><meta name="copyright" content="Neorah"><title>任意密码重置漏洞 | Neorah's Blog</title><link rel="shortcut icon" href="/img/melody-favicon32.ico"><link rel="stylesheet" href="/css/index.css?version=1.7.0"><link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/4.7.0/css/font-awesome.min.css?version=1.7.0"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  }
} </script><meta name="generator" content="Hexo 4.2.0"></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="切换文章详情">切换站点概览</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#0x00-本次总结"><span class="toc-number">1.</span> <span class="toc-text">0x00 本次总结</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x01-漏洞介绍"><span class="toc-number">2.</span> <span class="toc-text">0x01 漏洞介绍</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x02-常见类型"><span class="toc-number">3.</span> <span class="toc-text">0x02 常见类型</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x03-测试"><span class="toc-number">4.</span> <span class="toc-text">0x03 测试</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#验证码无时效性或有效时间较长"><span class="toc-number">4.0.1.</span> <span class="toc-text">验证码无时效性或有效时间较长</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#验证码未绑定用户"><span class="toc-number">4.0.2.</span> <span class="toc-text">验证码未绑定用户</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#验证步骤跳过"><span class="toc-number">4.0.3.</span> <span class="toc-text">验证步骤跳过</span></a></li></ol></li></ol></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="/img/neorah.jpg"></div><div class="author-info__name text-center">Neorah</div><div class="author-info__description text-center"></div><div class="follow-button"><a href="https://github.com/Neorah" target="_blank" rel="noopener">Follow Me</a></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">Articles</span><span class="pull-right">21</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">Tag</span><span class="pull-right">25</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">Category</span><span class="pull-right">30</span></a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(/img/top.JPG)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">Neorah's Blog</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Posts</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a><a class="site-page" href="/about">About</a></span><span class="pull-right"></span></div><div id="post-info"><div id="post-title">任意密码重置漏洞</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-02-22</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/">渗透测试</a><div class="post-meta-wordcount"><span>字数总计: </span><span class="word-count">2.3k</span><span class="post-meta__separator">|</span><span>阅读时长: 6 分钟</span></div></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><h1 id="0x00-本次总结"><a href="#0x00-本次总结" class="headerlink" title="0x00 本次总结"></a>0x00 本次总结</h1><p>本次课主要讲了任意密码重置漏洞。根据名字就能看出来，这种漏洞是利用开发程序猿在做⽹站时没有注意到的⼀一些逻辑问题，从⽽能够修改其他⽤户的密码。⽽而次讲到的10种测试⽅法也不限于在任意密码重置漏洞时使⽤用，在之前讲过的⽔平越权、短信轰炸时也可能用到这些⽅法。</p>
<h1 id="0x01-漏洞介绍"><a href="#0x01-漏洞介绍" class="headerlink" title="0x01 漏洞介绍"></a>0x01 漏洞介绍</h1><p>任意密码重置是最常见的逻辑漏洞之一，即能够通过该漏洞重置任意用户的登陆密码，从而达到攻击的目的。</p>
<p>该漏洞可能出现在新用户注册页面，也可能是用户登录后重置密码的页面，或者用户忘记密码时的密码找回页面(最为常见)。</p>
<img src="/pentest/%E4%BB%BB%E6%84%8F%E5%AF%86%E7%A0%81%E9%87%8D%E7%BD%AE/1.png" class="">

<p>常涉及的对象有：用户，手机号，邮箱，验证码。</p>
<p>攻击思路：伪装，窃取和绕过</p>
<h1 id="0x02-常见类型"><a href="#0x02-常见类型" class="headerlink" title="0x02 常见类型"></a>0x02 常见类型</h1><ul>
<li>验证码⽆时效性或有效时较长</li>
</ul>
<p>这种类型是由于验证码的时效性缺少或过⻓，⽽验证码又多是6位以内的数字组合，因此验证码就有可能被爆破成功。</p>
<p>造成原因：验证码缺少时间限制，仅判断验证码是否正确，而未判断验证码是否过期</p>
<p>攻击方法：通过枚举法找到正确的验证码完成密码重置</p>
<ul>
<li>验证码直接返回</li>
</ul>
<p>我觉得这种类型的情况应该⽐较少，它是由于验证码直接在客户端⽣成，所以我们可以在<strong>response</strong>中看到验证码，就容易被利用导致漏洞。</p>
<p>攻击方法：在界面输入目标手机号，进入开发者工具界面(F12)，点击获取验证码，观察返回包的Response，获得正确验证码，重置密码。测试阶段可以用“自己的手机号”获取验证码，在返回包中用“CTRL + F”查找是否存在验证码返回。</p>
<p>防御办法：不将验证码直接返回，严格控制返回包中的信息。</p>
<ul>
<li>验证码未绑定用户</li>
</ul>
<p>验证码未绑定⽤户主要是由于网站后台只验证了验证码，没有将手机号和验证码绑定起来验证，因此此处就可能出现漏洞。</p>
<p>攻击方法：重置密码时输入自己的手机号， 在输入验证码后截获发送的数据包，将自己的手机号修改为目标手机号，从而重置对方用户密码。</p>
<p>防御办法：绑定验证码与手机号。</p>
<ul>
<li>修改接收的手机或邮箱</li>
</ul>
<p>此种方法的原理就是后台未将⽤户名、⼿机号、验证码绑定在一起验证，只是在后台验证了⼿机号是否与验证码匹配。</p>
<p>攻击方法：输入用户名和手机号获取验证码，拦截数据包修改手机号为“自己的手机号”，获得验证码并提交，验证成功进行密码重置。</p>
<p>防御办法：绑定用户名，验证码与手机号。（邮箱同理）</p>
<ul>
<li>本地验证绕过</li>
</ul>
<p>这种类型的造成原因是网站有时在本地进行验证码正确与否的判断，⽽判断结果也会在本地被⽤户修改，判断结果被修改后客户端就会认为验证码正确，从⽽导致漏洞。</p>
<p>攻击方法：重置目标用户密码，输入错误的验证码之后修改返回包，改为正确，欺骗验证机制，重置密码。</p>
<p>防御办法：由服务器验证(无单独的重置密码界面)，返回包里的结果进行一定处理(加密)</p>
<ul>
<li>验证步骤跳过</li>
</ul>
<p>这种⽅法的原理是有些网站的重置密码界面会分为几个步骤，类似这种</p>
<img src="/pentest/%E4%BB%BB%E6%84%8F%E5%AF%86%E7%A0%81%E9%87%8D%E7%BD%AE/2.png" class="">

<p>⽽如果后台对修改密码的步骤没有做基于上下文的访问控制的话，就有可能导致可以直接输入最终修改密码的网址，直接跳转该⻚面，然后输入新密码达到重置密码的⽬的。</p>
<p>攻击方法：首先用“自己的手机号”完整走一次重置密码的流程，记录每一个流程的网址，如果重置密码有单独的界面则保存下来，重置目标用户密码时，点击获取验证码之后直接访问重置网址，从而跳过验证步骤，重置密码。</p>
<p>防御办法：加强基于上下文的访问控制，或者只用一个网页</p>
<ul>
<li>未校验⽤户身份字段</li>
</ul>
<p>这种类型与上文的⼀种⽅法比较像，后台在设置新密码时未对⽤户身份进行验证。针对这种情况，我们就可以先⽤用攻击者账号走到更改密码那一步，然后抓包，将号码改成受害者的，达到重置他们密码的⽬的。</p>
<p>攻击方法：用“自己的手机号”完整走一次重置密码的流程，记录每一个流程的网址，在最后设置密码的步骤中拦截数据包，将用户名(或者手机号)改为目标用户，重置密码。</p>
<p>防御办法：全程添加用户认证(cookie)，或者只用一个网页。</p>
<ul>
<li>Cookie值替换</li>
</ul>
<p>这种类型是由于后台在重置密码时只判断⽤户的<strong>cookie</strong>是否有效，没有判定<strong>cookie</strong>是否能通过之前重置密码的步骤，导致可替换<strong>cookie</strong>重置他人的密码。</p>
<p>攻击方法：修改自己账号的密码，在最后一步拦截数据包备用，重新进行第一步，用目标手机号获取验证码，可从数据包中获得目标cookie，替换到之前的备用数据包，发送重置密码。</p>
<p>防御办法：添加用户身份认证。</p>
<p>并且这种漏洞可以与CSRF一起使用，能够提高其危险系数。</p>
<img src="/pentest/%E4%BB%BB%E6%84%8F%E5%AF%86%E7%A0%81%E9%87%8D%E7%BD%AE/3.png" class="">

<ul>
<li>隐藏⽤用户标识修改</li>
</ul>
<p>这种类型的漏洞大概是后台处理修改信息的时候要将数据保存到数据库中，而在执行那些修改信息的 <strong>SQL</strong>语句的时候，将用户的密码也当作字段执行了了，而且是根据隐藏参数<strong>loginid</strong>(对应⽤户信息的参数)来执行的，这样就导致可以通过修改隐藏<strong>loginid</strong>的值来修改他⼈人密码。</p>
<p>攻击方法：修改“个人资料”的时候，抓取数据包，然后修改数据包的参数和对应的值，参数名数据包后面，替换为隐藏的参数即可修改密码。</p>
<p>防御办法：添加用户身份认证。</p>
<p>（这一步我又偷学长的步骤和图了）</p>
<ol>
<li>点击“保存信息”，抓取数据包。</li>
</ol>
<img src="/pentest/%E4%BB%BB%E6%84%8F%E5%AF%86%E7%A0%81%E9%87%8D%E7%BD%AE/4.png" class="">

<ol start="2">
<li>数据包中有mobileNo、departId、minority、sex，都是可修改的参数，没有唯一标识符，猜测是否有隐藏参数。</li>
</ol>
<img src="/pentest/%E4%BB%BB%E6%84%8F%E5%AF%86%E7%A0%81%E9%87%8D%E7%BD%AE/5.png" class="">

<ol start="3">
<li>在页面源码中发现隐藏参数loginid，该参数对应用户身份。</li>
</ol>
<img src="/pentest/%E4%BB%BB%E6%84%8F%E5%AF%86%E7%A0%81%E9%87%8D%E7%BD%AE/6.png" class="">

<ol start="4">
<li>将数据包中的“mobileNo”改为“loginid”，后面的177xxxx手机号改为用户id，如“hacker1024”，发送后loginid参数会被修改为“hacker1024”，并且该用户的密码与自己密码相同，可直接登陆。</li>
</ol>
<img src="/pentest/%E4%BB%BB%E6%84%8F%E5%AF%86%E7%A0%81%E9%87%8D%E7%BD%AE/7.png" class="">



<h1 id="0x03-测试"><a href="#0x03-测试" class="headerlink" title="0x03 测试"></a>0x03 测试</h1><h3 id="验证码无时效性或有效时间较长"><a href="#验证码无时效性或有效时间较长" class="headerlink" title="验证码无时效性或有效时间较长"></a>验证码无时效性或有效时间较长</h3><p><strong>1.</strong>由于这种类型需要验证码时间较长的网站，于是我先到找了一个⼿机号，看了下它收到的历史短信，发现其中有⼏条短信内容中未显示验证码有效时长或有效时间较长，于是我找了几个网站。</p>
<img src="/pentest/%E4%BB%BB%E6%84%8F%E5%AF%86%E7%A0%81%E9%87%8D%E7%BD%AE/8.png" class="">

<p><strong>2.</strong>找到这个网站后，我向临时手机号发送了一条短信验证码。</p>
<img src="/pentest/%E4%BB%BB%E6%84%8F%E5%AF%86%E7%A0%81%E9%87%8D%E7%BD%AE/9.png" class="">

<p><strong>3.</strong>验证码是6位，并且有10分钟的有效时长，本着测试的心态，我记下了这条验证码。并且准备在真实验证码周围来爆破它。⽤这样的⽅式测试一下是否可行。（只是测试，真实挖洞应该不会有人去暴力猜6位验证码吧？？不会吧不会吧）</p>
<img src="/pentest/%E4%BB%BB%E6%84%8F%E5%AF%86%E7%A0%81%E9%87%8D%E7%BD%AE/10.png" class="">

<p><strong>4.</strong>爆破开始了，我找到了真实验证码的<strong>response</strong>。</p>
<img src="/pentest/%E4%BB%BB%E6%84%8F%E5%AF%86%E7%A0%81%E9%87%8D%E7%BD%AE/11.png" class="">

<p>嗯？？怎么会是<strong>error</strong>呢，⽤这个真实的验证码在⻚面发送看看。</p>
<img src="/pentest/%E4%BB%BB%E6%84%8F%E5%AF%86%E7%A0%81%E9%87%8D%E7%BD%AE/12.png" class="">

<p>dbq有被冒犯到  </p>
<p>果然，虽然验证码时效长，但后台设定了验证码输入次数限制，那就不能爆破了<strong>qaq</strong>。</p>
<h3 id="验证码未绑定用户"><a href="#验证码未绑定用户" class="headerlink" title="验证码未绑定用户"></a>验证码未绑定用户</h3><p><strong>1.</strong>找到一个网站，注册后在登陆⻚面点击忘记密码。</p>
<img src="/pentest/%E4%BB%BB%E6%84%8F%E5%AF%86%E7%A0%81%E9%87%8D%E7%BD%AE/14.png" class="">

<p><strong>2.</strong>发送验证码后抓包。</p>
<img src="/pentest/%E4%BB%BB%E6%84%8F%E5%AF%86%E7%A0%81%E9%87%8D%E7%BD%AE/15.png" class="">

<p><strong>3.</strong>将正确的验证码填上去，再把⼿机号改成受害者的⼿机号。</p>
<img src="/pentest/%E4%BB%BB%E6%84%8F%E5%AF%86%E7%A0%81%E9%87%8D%E7%BD%AE/16.png" class="">

<p>果然失败了，挺好的。</p>
<h3 id="验证步骤跳过"><a href="#验证步骤跳过" class="headerlink" title="验证步骤跳过"></a>验证步骤跳过</h3><p><strong>1.</strong>先发送验证码，填好后将修改密码⻚面的⽹址记录下来。</p>
<img src="/pentest/%E4%BB%BB%E6%84%8F%E5%AF%86%E7%A0%81%E9%87%8D%E7%BD%AE/17.png" class="">

<p><strong>2.</strong>重置受害者密码时，点击获取验证码之后直接访问重置网址。</p>
<img src="/pentest/%E4%BB%BB%E6%84%8F%E5%AF%86%E7%A0%81%E9%87%8D%E7%BD%AE/18.png" class="">

<p>重新访问重置密码网址之后又成了填写⼿机号界⾯了。。好叭⼜又失败了。</p>
<p>但我发现！虽然这类漏洞看起来很简单，但往往厉害的师傅们能通过很多骚姿势在这些简单的漏洞基础之上挖到对业务影响严重的高危的！比如本次的某团，队内大佬就挖到了此类高危漏洞👍🏻</p>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Neorah</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://neorah.me/pentest/%E4%BB%BB%E6%84%8F%E5%AF%86%E7%A0%81%E9%87%8D%E7%BD%AE/">https://neorah.me/pentest/%E4%BB%BB%E6%84%8F%E5%AF%86%E7%A0%81%E9%87%8D%E7%BD%AE/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/" target="_blank" rel="noopener">CC BY-NC-SA 3.0</a> 许可协议。转载请注明来自 <a href="https://neorah.me">Neorah's Blog</a>！</span></div></div><div class="post-meta__tag-list"></div><nav id="pagination"><div class="prev-post pull-left"><a href="/pentest/xss%E7%AE%80%E4%BB%8B%E5%8F%8A%E5%8E%9F%E7%90%86/"><i class="fa fa-chevron-left">  </i><span>xss简介及原理复现</span></a></div><div class="next-post pull-right"><a href="/pentest/%E6%B0%B4%E5%B9%B3%E8%B6%8A%E6%9D%83/"><span>水平越权漏洞</span><i class="fa fa-chevron-right"></i></a></div></nav></div></div><footer class="footer-bg" style="background-image: url(/img/top.JPG)"><div class="layout" id="footer"><div class="copyright">&copy;2020 By Neorah</div><div class="footer_custom_text">Theme By melody</div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file-o"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="/js/third-party/anime.min.js"></script><script src="/js/third-party/jquery.min.js"></script><script src="/js/third-party/jquery.fancybox.min.js"></script><script src="/js/third-party/velocity.min.js"></script><script src="/js/third-party/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.7.0"></script><script src="/js/fancybox.js?version=1.7.0"></script><script src="/js/sidebar.js?version=1.7.0"></script><script src="/js/copy.js?version=1.7.0"></script><script src="/js/fireworks.js?version=1.7.0"></script><script src="/js/transition.js?version=1.7.0"></script><script src="/js/scroll.js?version=1.7.0"></script><script src="/js/head.js?version=1.7.0"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script></body></html>