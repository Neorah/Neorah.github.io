<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="内网信息收集"><meta name="keywords" content=""><meta name="author" content="Neorah"><meta name="copyright" content="Neorah"><title>内网信息收集 | Neorah's Blog</title><link rel="shortcut icon" href="/img/melody-favicon32.ico"><link rel="stylesheet" href="/css/index.css?version=1.7.0"><link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/4.7.0/css/font-awesome.min.css?version=1.7.0"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.1.1/dist/instantsearch.min.css"><script src="https://cdn.jsdelivr.net/npm/instantsearch.js@2.1.1/dist/instantsearch.min.js" defer></script><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: {"appId":"DBINOT6FYU","apiKey":"c8bb9d887053d084aa4aee885c26cac5","indexName":"dev_Neorah","hits":{"per_page":10},"languages":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}.","hits_stats":"${hits} results found in ${time} ms"}},
  localSearch: undefined,
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  }
} </script><meta name="generator" content="Hexo 4.2.0"></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="Toggle article">Toggle site</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#前言"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#收集本机信息"><span class="toc-number">2.</span> <span class="toc-text">收集本机信息</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#手动收集信息"><span class="toc-number">2.1.</span> <span class="toc-text">手动收集信息</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#查询网络配置信息"><span class="toc-number">2.1.1.</span> <span class="toc-text">查询网络配置信息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#查询操作系统和版本信息"><span class="toc-number">2.1.2.</span> <span class="toc-text">查询操作系统和版本信息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#查询本机服务信息"><span class="toc-number">2.1.3.</span> <span class="toc-text">查询本机服务信息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#查询进程列表"><span class="toc-number">2.1.4.</span> <span class="toc-text">查询进程列表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#查看启动程序信息"><span class="toc-number">2.1.5.</span> <span class="toc-text">查看启动程序信息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#查看计划任务"><span class="toc-number">2.1.6.</span> <span class="toc-text">查看计划任务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#查询用户列表"><span class="toc-number">2.1.7.</span> <span class="toc-text">查询用户列表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#会话"><span class="toc-number">2.1.8.</span> <span class="toc-text">会话</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#查询端口列表"><span class="toc-number">2.1.9.</span> <span class="toc-text">查询端口列表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#查看补丁列表"><span class="toc-number">2.1.10.</span> <span class="toc-text">查看补丁列表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#查询本机共享列表"><span class="toc-number">2.1.11.</span> <span class="toc-text">查询本机共享列表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#查询路由表"><span class="toc-number">2.1.12.</span> <span class="toc-text">查询路由表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#查询防火墙相关配置"><span class="toc-number">2.1.13.</span> <span class="toc-text">查询防火墙相关配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#查看代理配置情况"><span class="toc-number">2.1.14.</span> <span class="toc-text">查看代理配置情况</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#查询并开启远程连接服务"><span class="toc-number">2.1.15.</span> <span class="toc-text">查询并开启远程连接服务</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#自动收集信息"><span class="toc-number">2.2.</span> <span class="toc-text">自动收集信息</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#查询当前权限"><span class="toc-number">3.</span> <span class="toc-text">查询当前权限</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#判断是否存在域"><span class="toc-number">4.</span> <span class="toc-text">判断是否存在域</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#查看网关IP地址、域名等"><span class="toc-number">4.1.</span> <span class="toc-text">查看网关IP地址、域名等</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#查看系统详细信息"><span class="toc-number">4.2.</span> <span class="toc-text">查看系统详细信息</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#查询当前登陆域及登陆用户信息"><span class="toc-number">4.3.</span> <span class="toc-text">查询当前登陆域及登陆用户信息</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#判断主域"><span class="toc-number">4.4.</span> <span class="toc-text">判断主域</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#探测域内存活主机"><span class="toc-number">5.</span> <span class="toc-text">探测域内存活主机</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#利用NetBIOS"><span class="toc-number">5.1.</span> <span class="toc-text">利用NetBIOS</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#收集域内基础信息"><span class="toc-number">6.</span> <span class="toc-text">收集域内基础信息</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#查询域"><span class="toc-number">6.1.</span> <span class="toc-text">查询域</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#查询域内所有计算机"><span class="toc-number">6.2.</span> <span class="toc-text">查询域内所有计算机</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#查询域内所有用户组列表"><span class="toc-number">6.3.</span> <span class="toc-text">查询域内所有用户组列表</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#查询域内所有域成员计算机列表"><span class="toc-number">6.4.</span> <span class="toc-text">查询域内所有域成员计算机列表</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#查找域控制器"><span class="toc-number">7.</span> <span class="toc-text">查找域控制器</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#查看域控制器的机器名"><span class="toc-number">7.1.</span> <span class="toc-text">查看域控制器的机器名</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#查看域控制器的主机名"><span class="toc-number">7.2.</span> <span class="toc-text">查看域控制器的主机名</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#查看域控制器组"><span class="toc-number">7.3.</span> <span class="toc-text">查看域控制器组</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#获取域内的用户和管理员信息"><span class="toc-number">8.</span> <span class="toc-text">获取域内的用户和管理员信息</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#查询所有域用户列表"><span class="toc-number">8.1.</span> <span class="toc-text">查询所有域用户列表</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#查询域管理员用户"><span class="toc-number">8.2.</span> <span class="toc-text">查询域管理员用户</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#定位域管理员"><span class="toc-number">9.</span> <span class="toc-text">定位域管理员</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#概述"><span class="toc-number">9.1.</span> <span class="toc-text">概述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#psloggedon-exe"><span class="toc-number">9.2.</span> <span class="toc-text">psloggedon.exe</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#PVEFindADUser-exe"><span class="toc-number">9.3.</span> <span class="toc-text">PVEFindADUser.exe</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#netview-exe"><span class="toc-number">9.4.</span> <span class="toc-text">netview.exe</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#PowerView"><span class="toc-number">9.5.</span> <span class="toc-text">PowerView</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Empire中的user-hunter模块"><span class="toc-number">9.6.</span> <span class="toc-text">Empire中的user_hunter模块</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#查找域管理进程"><span class="toc-number">10.</span> <span class="toc-text">查找域管理进程</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#本机检查"><span class="toc-number">10.1.</span> <span class="toc-text">本机检查</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#查询域控制器的域用户会话"><span class="toc-number">10.2.</span> <span class="toc-text">查询域控制器的域用户会话</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#查询远程系统中运行的任务"><span class="toc-number">10.3.</span> <span class="toc-text">查询远程系统中运行的任务</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#扫描远程系统的NetBIOS信息"><span class="toc-number">10.4.</span> <span class="toc-text">扫描远程系统的NetBIOS信息</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#利用PowerShell收集域信息"><span class="toc-number">10.5.</span> <span class="toc-text">利用PowerShell收集域信息</span></a></li></ol></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="/img/neorah.jpg"></div><div class="author-info__name text-center">Neorah</div><div class="author-info__description text-center"></div><div class="follow-button"><a href="https://github.com/Neorah" target="_blank" rel="noopener">Follow Me</a></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">Articles</span><span class="pull-right">44</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">Tags</span><span class="pull-right">38</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">Categories</span><span class="pull-right">36</span></a></div><hr><div class="author-info-links"><div class="author-info-links__title text-center">Friends</div><a class="author-info-links__name text-center" href="http://blog.happysec.cn" target="_blank" rel="noopener">小北</a><a class="author-info-links__name text-center" href="https://ha1c9on.top/" target="_blank" rel="noopener">ha1c9on</a><a class="author-info-links__name text-center" href="http://www.const27.com" target="_blank" rel="noopener">const27</a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(/img/top.JPG)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">Neorah's Blog</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Posts</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a><a class="site-page" href="/about">About</a></span><span class="pull-right"><a class="site-page social-icon search"><i class="fa fa-search"></i><span> Search</span></a></span></div><div id="post-info"><div id="post-title">内网信息收集</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-11-03</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/">渗透测试</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/%E5%9F%9F%E6%B8%97%E9%80%8F/">域渗透</a><div class="post-meta-wordcount"><span>Word count: </span><span class="word-count">3.1k</span><span class="post-meta__separator">|</span><span>Reading time: 12 min</span></div></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>本文主要是我在学习过程中的一点笔记 重点在信息收集</p>
<h1 id="收集本机信息"><a href="#收集本机信息" class="headerlink" title="收集本机信息"></a>收集本机信息</h1><h2 id="手动收集信息"><a href="#手动收集信息" class="headerlink" title="手动收集信息"></a>手动收集信息</h2><h3 id="查询网络配置信息"><a href="#查询网络配置信息" class="headerlink" title="查询网络配置信息"></a>查询网络配置信息</h3><p><code>ipconfig /all</code></p>
<h3 id="查询操作系统和版本信息"><a href="#查询操作系统和版本信息" class="headerlink" title="查询操作系统和版本信息"></a>查询操作系统和版本信息</h3><p>英文版：</p>
<p><code>systeminfo | findstr /B /C:&quot;OS Name&quot; /C:&quot;OS Version&quot;</code></p>
<p>中文版：</p>
<p><code>systeminfo |findstr /B /C:&quot;OS 名称&quot; /C:&quot;OS 版本&quot;</code></p>
<p>查看系统体系结构：</p>
<p><code>echo %PROCESSOR_AECHITECTURE%</code></p>
<p>查看安装软件及版本、路径等：</p>
<p><code>wmic product get name,version</code></p>
<p><code>powershell &quot;Get-WmiObject -class Win32_Product |Select-Object -Property name,version&quot;</code></p>
<h3 id="查询本机服务信息"><a href="#查询本机服务信息" class="headerlink" title="查询本机服务信息"></a>查询本机服务信息</h3><p><code>wmic service list brief</code></p>
<h3 id="查询进程列表"><a href="#查询进程列表" class="headerlink" title="查询进程列表"></a>查询进程列表</h3><p>查看当前进程列表和进程用户：</p>
<p><code>tasklist</code></p>
<p>查看进程信息：</p>
<p><code>wmic process list brief</code></p>
<h3 id="查看启动程序信息"><a href="#查看启动程序信息" class="headerlink" title="查看启动程序信息"></a>查看启动程序信息</h3><p><code>wmic startup get command,caption</code></p>
<h3 id="查看计划任务"><a href="#查看计划任务" class="headerlink" title="查看计划任务"></a>查看计划任务</h3><p><code>schtasks /query /fo LIST /v</code></p>
<h3 id="查询用户列表"><a href="#查询用户列表" class="headerlink" title="查询用户列表"></a>查询用户列表</h3><p>查看本机用户列表：</p>
<p><code>net user</code></p>
<p>获取本地管理员信息：</p>
<p><code>net localgroup administrators</code></p>
<p>查看当前在线用户：</p>
<p><code>query user || qwinsta</code></p>
<h3 id="会话"><a href="#会话" class="headerlink" title="会话"></a>会话</h3><p>列出或断开本地计算机与所连接客户端之间的会话：</p>
<p><code>net session</code></p>
<h3 id="查询端口列表"><a href="#查询端口列表" class="headerlink" title="查询端口列表"></a>查询端口列表</h3><p>查看端口列表、本机开放端口所对应的服务和应用程序：</p>
<p><code>netstat -ano</code></p>
<h3 id="查看补丁列表"><a href="#查看补丁列表" class="headerlink" title="查看补丁列表"></a>查看补丁列表</h3><p>查看系统详细信息：</p>
<p><code>systeminfo</code></p>
<p>查看安装在系统的补丁：</p>
<p><code>wmic qfe get Caption.Description,HotFixID,InstalledOn</code></p>
<h3 id="查询本机共享列表"><a href="#查询本机共享列表" class="headerlink" title="查询本机共享列表"></a>查询本机共享列表</h3><p>查看本机共享列表和可访问的域共享列表：</p>
<p><code>net share</code></p>
<p>用wmic命令查找共享列表：</p>
<p><code>wmic share get name,path,status</code></p>
<h3 id="查询路由表"><a href="#查询路由表" class="headerlink" title="查询路由表"></a>查询路由表</h3><p>查询路由表及所有可用接口的ARP（地址解析协议）缓存表：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">route print</span><br><span class="line">arp -a</span><br></pre></td></tr></table></figure>

<h3 id="查询防火墙相关配置"><a href="#查询防火墙相关配置" class="headerlink" title="查询防火墙相关配置"></a>查询防火墙相关配置</h3><ul>
<li><p>关闭防火墙</p>
<p>Windows Server 2003及之前的版本：</p>
<p><code>netsh firewall set opmode disable</code></p>
<p>之后的：</p>
<p><code>netsh advfirewall set allprofiles state off</code></p>
</li>
<li><p>查看防火墙配置</p>
<p><code>netsh firewall show config</code></p>
</li>
<li><p>修改防火墙配置</p>
<p>Windows Server 2003及之前的版本，允许指定程序全部链接：</p>
<p><code>netsh firewall add allowedprogram c:\nc.exe &quot;allow nc&quot; enable</code></p>
<p>之后的版本：</p>
<p>允许指定程序进入：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">netsh advfirewall firewall add rule name&#x3D;&quot;pass nc&quot; dir&#x3D;in action&#x3D;allow program&#x3D;&quot;C: \nc.exe&quot;</span><br></pre></td></tr></table></figure>

<p>允许指定程序退出：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">netsh advfirewall firewall add rule name&#x3D;&quot;Allow nc&quot; dir&#x3D;out action&#x3D;allow program&#x3D;&quot;C \nc.exe&quot;</span><br></pre></td></tr></table></figure>

<p>允许3389端口放行：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">netsh advfirewall firewall add rule name&#x3D;&quot;Remote Desktop&quot; protocol&#x3D;TCP dir&#x3D;in localport&#x3D;3389 action&#x3D;allow</span><br></pre></td></tr></table></figure>



</li>
</ul>
<h3 id="查看代理配置情况"><a href="#查看代理配置情况" class="headerlink" title="查看代理配置情况"></a>查看代理配置情况</h3><p>查看到服务器127.0.0.1的1080端口的代理配置信息：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">reg query &quot;HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Internet Settings&quot;</span><br></pre></td></tr></table></figure>



<h3 id="查询并开启远程连接服务"><a href="#查询并开启远程连接服务" class="headerlink" title="查询并开启远程连接服务"></a>查询并开启远程连接服务</h3><ul>
<li><p>查看远程连接端口</p>
<p>执行注册表查询语句：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">REG QUERY &quot;HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp&quot; &#x2F;V PortNumber</span><br></pre></td></tr></table></figure>
</li>
<li><p>在Windows Server 2003中开启3389端口：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">wmic path win32_terminalservicesetting where (__CLASS !&#x3D;&quot;&quot;) call setallowtsconnections 1</span><br></pre></td></tr></table></figure>
</li>
<li><p>在Windows Server 2008和Windows Server 2012中开启3389</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">wmic &#x2F;namespace:\\root\cimv2\terminalservices path win32_terminalservicesetting where (__CLASS !&#x3D; &quot;&quot;) call setallowtsconnections 1</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">wmic  &#x2F;namespace:\\root\cimv2\terminalservices path win32_tsgeneralsetting where (TerminalName &#x3D;&#39;RDP-Tcp&#39;) call setuserauthenticationrequired 1</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">reg add &quot;HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server&quot; &#x2F;v fSingleSessionPerUser &#x2F;t REG_DWORD &#x2F;d 0 &#x2F;f</span><br></pre></td></tr></table></figure>



</li>
</ul>
<h2 id="自动收集信息"><a href="#自动收集信息" class="headerlink" title="自动收集信息"></a>自动收集信息</h2><p>wmic的自动收集脚本，其实就是自动执行一些wmic命令然后保存到html文件中</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">for &#x2F;f &quot;delims&#x3D;&quot; %%A in (&#39;dir &#x2F;s &#x2F;b %WINDIR%\system32\*htable.xsl&#39;) do set &quot;var&#x3D;%%A&quot;</span><br><span class="line"></span><br><span class="line">wmic process get CSName,Description,ExecutablePath,ProcessId &#x2F;format:&quot;%var%&quot; &gt;&gt; out.html</span><br><span class="line">wmic service get Caption,Name,PathName,ServiceType,Started,StartMode,StartName &#x2F;format:&quot;%var%&quot; &gt;&gt; out.html</span><br><span class="line">wmic USERACCOUNT list full &#x2F;format:&quot;%var%&quot; &gt;&gt; out.html</span><br><span class="line">wmic group list full &#x2F;format:&quot;%var%&quot; &gt;&gt; out.html</span><br><span class="line">wmic nicconfig where IPEnabled&#x3D;&#39;true&#39; get Caption,DefaultIPGateway,Description,DHCPEnabled,DHCPServer,IPAddress,IPSubnet,MACAddress &#x2F;format:&quot;%var%&quot; &gt;&gt; out.html</span><br><span class="line">wmic volume get Label,DeviceID,DriveLetter,FileSystem,Capacity,FreeSpace &#x2F;format:&quot;%var%&quot; &gt;&gt; out.html</span><br><span class="line">wmic netuse list full &#x2F;format:&quot;%var%&quot; &gt;&gt; out.html</span><br><span class="line">wmic qfe get Caption,Description,HotFixID,InstalledOn &#x2F;format:&quot;%var%&quot; &gt;&gt; out.html</span><br><span class="line">wmic startup get Caption,Command,Location,User &#x2F;format:&quot;%var%&quot; &gt;&gt; out.html</span><br><span class="line">wmic PRODUCT get Description,InstallDate,InstallLocation,PackageCache,Vendor,Version &#x2F;format:&quot;%var%&quot; &gt;&gt; out.html</span><br><span class="line">wmic os get name,version,InstallDate,LastBootUpTime,LocalDateTime,Manufacturer,RegisteredUser,ServicePackMajorVersion,SystemDirectory &#x2F;format:&quot;%var%&quot; &gt;&gt; out.html</span><br><span class="line">wmic Timezone get DaylightName,Description,StandardName &#x2F;format:&quot;%var%&quot; &gt;&gt; out.html</span><br></pre></td></tr></table></figure>

<p>下载地址：<a href="http://www.fuzzysecurity.com/scripts/files/wmic_info.rar" target="_blank" rel="noopener">http://www.fuzzysecurity.com/scripts/files/wmic_info.rar</a></p>
<h1 id="查询当前权限"><a href="#查询当前权限" class="headerlink" title="查询当前权限"></a>查询当前权限</h1><p><code>whoami</code></p>
<p><code>whoami /all</code></p>
<p>查询指定用户的详细信息：</p>
<p><code>net user xxx /domain</code> </p>
<img src="/pentest/%E5%86%85%E7%BD%91%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86/1.png" class="">



<h1 id="判断是否存在域"><a href="#判断是否存在域" class="headerlink" title="判断是否存在域"></a>判断是否存在域</h1><h2 id="查看网关IP地址、域名等"><a href="#查看网关IP地址、域名等" class="headerlink" title="查看网关IP地址、域名等"></a>查看网关IP地址、域名等</h2><p><code>ipconfig /all</code></p>
<p>用nslookup解析域名，这样可以用解析得到的IP地址与DNS服务器进行对比，判断它们是否在同一台服务器上</p>
<h2 id="查看系统详细信息"><a href="#查看系统详细信息" class="headerlink" title="查看系统详细信息"></a>查看系统详细信息</h2><p><code>systeminfo</code></p>
<img src="/pentest/%E5%86%85%E7%BD%91%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86/2.png" class="">

<p>“域”为域名，“登陆服务器”为域控制器。如果“域”为WORKGROUP，表示当前服务器不在域内。</p>
<h2 id="查询当前登陆域及登陆用户信息"><a href="#查询当前登陆域及登陆用户信息" class="headerlink" title="查询当前登陆域及登陆用户信息"></a>查询当前登陆域及登陆用户信息</h2><p><code>net config workstation</code></p>
<p>windows server2012：</p>
<img src="/pentest/%E5%86%85%E7%BD%91%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86/3.png" class="">

<p>win7:</p>
<img src="/pentest/%E5%86%85%E7%BD%91%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86/4.png" class="">

<p>“工作站域DNS名称”为域名</p>
<p>“登陆域”用于表示当前登陆的恶用户是域用户还是本地用户。</p>
<h2 id="判断主域"><a href="#判断主域" class="headerlink" title="判断主域"></a>判断主域</h2><p><code>net time /domain</code></p>
<p>域服务器通常会作为时间服务器使用，win7上运行命令为：</p>
<img src="/pentest/%E5%86%85%E7%BD%91%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86/5.png" class="">



<h1 id="探测域内存活主机"><a href="#探测域内存活主机" class="headerlink" title="探测域内存活主机"></a>探测域内存活主机</h1><h2 id="利用NetBIOS"><a href="#利用NetBIOS" class="headerlink" title="利用NetBIOS"></a>利用NetBIOS</h2><p><a href="https://github.com/MrAnonymous-1/nbtscan" target="_blank" rel="noopener">下载地址</a></p>
<img src="/pentest/%E5%86%85%E7%BD%91%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86/6.png" class="">



<h1 id="收集域内基础信息"><a href="#收集域内基础信息" class="headerlink" title="收集域内基础信息"></a>收集域内基础信息</h1><h2 id="查询域"><a href="#查询域" class="headerlink" title="查询域"></a>查询域</h2><p><code>net view /domain</code></p>
<img src="/pentest/%E5%86%85%E7%BD%91%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86/7.png" class="">

<h2 id="查询域内所有计算机"><a href="#查询域内所有计算机" class="headerlink" title="查询域内所有计算机"></a>查询域内所有计算机</h2><p><code>net view /domain:NEORAH</code></p>
<img src="/pentest/%E5%86%85%E7%BD%91%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86/8.png" class="">

<p>可以根据查询到的主机名对主机角色进行判断。</p>
<h2 id="查询域内所有用户组列表"><a href="#查询域内所有用户组列表" class="headerlink" title="查询域内所有用户组列表"></a>查询域内所有用户组列表</h2><p><code>net group /domain</code></p>
<h2 id="查询域内所有域成员计算机列表"><a href="#查询域内所有域成员计算机列表" class="headerlink" title="查询域内所有域成员计算机列表"></a>查询域内所有域成员计算机列表</h2><p><code>net group &quot;domain computers&quot; /domain</code></p>
<h1 id="查找域控制器"><a href="#查找域控制器" class="headerlink" title="查找域控制器"></a>查找域控制器</h1><h2 id="查看域控制器的机器名"><a href="#查看域控制器的机器名" class="headerlink" title="查看域控制器的机器名"></a>查看域控制器的机器名</h2><p><code>nltest /DCLIST:neorah</code></p>
<img src="/pentest/%E5%86%85%E7%BD%91%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86/9.png" class="">

<p>或者以下命令也可以</p>
<p><code>netdom query pdc</code></p>
<img src="/pentest/%E5%86%85%E7%BD%91%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86/12.png" class="">

<p>看到机器名为DC</p>
<h2 id="查看域控制器的主机名"><a href="#查看域控制器的主机名" class="headerlink" title="查看域控制器的主机名"></a>查看域控制器的主机名</h2><p><code>Nslookup -type=SRV _ldap._tcp</code></p>
<img src="/pentest/%E5%86%85%E7%BD%91%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86/10.png" class="">

<p>可以看出主机名为dc</p>
<h2 id="查看域控制器组"><a href="#查看域控制器组" class="headerlink" title="查看域控制器组"></a>查看域控制器组</h2><p><code>net group &quot;Domain Controllers&quot; /domain</code></p>
<img src="/pentest/%E5%86%85%E7%BD%91%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86/11.png" class="">



<h1 id="获取域内的用户和管理员信息"><a href="#获取域内的用户和管理员信息" class="headerlink" title="获取域内的用户和管理员信息"></a>获取域内的用户和管理员信息</h1><h2 id="查询所有域用户列表"><a href="#查询所有域用户列表" class="headerlink" title="查询所有域用户列表"></a>查询所有域用户列表</h2><ol>
<li><p>向域控进行查询</p>
<p><code>net user /domain</code></p>
</li>
</ol>
<img src="/pentest/%E5%86%85%E7%BD%91%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86/13.png" class="">

<ol start="2">
<li><p>获取域内用户详细信息</p>
<p><code>wmic useraccount get /all</code></p>
</li>
</ol>
<img src="/pentest/%E5%86%85%E7%BD%91%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86/14.png" class="">

<ol start="3">
<li><p>查看存在的用户</p>
<p><code>dsquery user</code></p>
</li>
<li><p>查询本地管理员组用户</p>
<p><code>net localgroup administrators</code></p>
</li>
</ol>
<img src="/pentest/%E5%86%85%E7%BD%91%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86/15.png" class="">

<h2 id="查询域管理员用户"><a href="#查询域管理员用户" class="headerlink" title="查询域管理员用户"></a>查询域管理员用户</h2><p><code>net group &quot;domain admins&quot; /domain</code></p>
<img src="/pentest/%E5%86%85%E7%BD%91%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86/16.png" class="">



<h1 id="定位域管理员"><a href="#定位域管理员" class="headerlink" title="定位域管理员"></a>定位域管理员</h1><h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>在一个域中，当计算机加入域后，会默认给域管理员赋予本地系统管理员的权限。因此当计算机被添加到域中，成为域的成员主机后，域管理员组的成员均可访问本地计算机，且具备完全控制权限。</p>
<p>定位域内管理员的常规渠道：</p>
<ul>
<li>日志</li>
<li>会话</li>
</ul>
<p>因此假设当我们获得了域中普通用户的权限，希望在进行横向渗透测试时，需要知道域中用户登陆的位置，是否是任何系统\主机的本地管理员、所属的组以及是否有权限访问文件共享等。</p>
<p>常用的域管理员定位工具有：psloggedon.exe、PVEFindADUser.exe、netness.exe、hunter、NetView，在Powershell中，常用的工具有PowerView。</p>
<h2 id="psloggedon-exe"><a href="#psloggedon-exe" class="headerlink" title="psloggedon.exe"></a>psloggedon.exe</h2><p>下载地址：<a href="https://docs.microsoft.com/zh-cn/sysinternals/downloads/psloggedon" target="_blank" rel="noopener">https://docs.microsoft.com/zh-cn/sysinternals/downloads/psloggedon</a></p>
<p>可以通过此工具查看本地登陆的用户和通过本地计算机或远程计算机的资源登陆的用户。</p>
<img src="/pentest/%E5%86%85%E7%BD%91%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86/17.png" class="">

<h2 id="PVEFindADUser-exe"><a href="#PVEFindADUser-exe" class="headerlink" title="PVEFindADUser.exe"></a>PVEFindADUser.exe</h2><p>PVEFindADUser能够用于查找活动目录用户登录的位置，枚举域用户，以及查找在特定计算机上登录的用户。包括本地用户、通过RDP登录的用户、用于运行服务和计划任务的用户。（这个工具需要.NET 3.5）但是需要管理员权限。</p>
<p>Windows Server 2012安装.NET 3.5可能不成功，需要指定安装源：<a href="https://www.cr173.com/soft/921507.html" target="_blank" rel="noopener">https://www.cr173.com/soft/921507.html</a></p>
<p>下载地址：<a href="https://github.com/chrisdee/Tools/tree/master/AD/ADFindUsersLoggedOn" target="_blank" rel="noopener">https://github.com/chrisdee/Tools/tree/master/AD/ADFindUsersLoggedOn</a></p>
<h2 id="netview-exe"><a href="#netview-exe" class="headerlink" title="netview.exe"></a>netview.exe</h2><p>netview.exe是一个枚举工具，使用WinAPI枚举系统，利用NetSessionEnum寻找登陆会话，利用NetShareEnum找寻共享，同时还能够查询共享入口和有价值的用户。</p>
<p>下载地址：<a href="https://github.com/mubix/netview/releases/tag/latest" target="_blank" rel="noopener">https://github.com/mubix/netview/releases/tag/latest</a></p>
<img src="/pentest/%E5%86%85%E7%BD%91%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86/18.png" class="">

<h2 id="PowerView"><a href="#PowerView" class="headerlink" title="PowerView"></a>PowerView</h2><p>下载地址：<a href="https://github.com/PowerShellMafia/PowerSploit/tree/master/Recon" target="_blank" rel="noopener">https://github.com/PowerShellMafia/PowerSploit/tree/master/Recon</a></p>
<h2 id="Empire中的user-hunter模块"><a href="#Empire中的user-hunter模块" class="headerlink" title="Empire中的user_hunter模块"></a>Empire中的user_hunter模块</h2><p>下载地址：<a href="https://github.com/EmpireProject/Empire" target="_blank" rel="noopener">https://github.com/EmpireProject/Empire</a></p>
<h1 id="查找域管理进程"><a href="#查找域管理进程" class="headerlink" title="查找域管理进程"></a>查找域管理进程</h1><p>假设在某个内网环境中获得到了一个域普通用户的权限，首先通过各种方法获得当前服务器的本地管理员权限，然后分析当前服务器的用户登陆列表及会话信息，知道哪些用户登录了这台服务器。如果可以获取权限的登录用户都不是域管理用户，同时没有域管理员登录这台电脑，那就比较复杂了，需要使用另一个账户并寻找该账户在哪台机器上有管理权限，再枚举该机器的登录用户，再进行渗透测试。</p>
<h2 id="本机检查"><a href="#本机检查" class="headerlink" title="本机检查"></a>本机检查</h2><ol>
<li>获取域管理员列表</li>
</ol>
<p><code>net group &quot;Domain Admins&quot; /domain</code></p>
<img src="/pentest/%E5%86%85%E7%BD%91%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86/19.png" class="">

<ol start="2">
<li>列出本机的所有进程及进程用户</li>
</ol>
<p><code>tasklist /v</code></p>
<ol start="3">
<li>寻找进程所有者为域管理员的进程</li>
</ol>
<p>从2中的命令再结合1是能够看出来是否有域管理员的进行。</p>
<h2 id="查询域控制器的域用户会话"><a href="#查询域控制器的域用户会话" class="headerlink" title="查询域控制器的域用户会话"></a>查询域控制器的域用户会话</h2><p>在域控制器中查询域用户会话列表，并将其与域管理员列表进行交叉引用，从而得到域管理会话的系统列表。</p>
<ol>
<li>查询域控制器列表</li>
</ol>
<p>可以使用LDAP查询从Domain Controllers单元中收集的域控制器列表。也可以使用net命令查询域控制器列表。</p>
<p><code>net group &quot;Domain Controllers&quot; /domain</code></p>
<ol start="2">
<li>收集域管理员列表</li>
</ol>
<p><code>net group &quot;Domain Admins&quot; /domain</code></p>
<ol start="3">
<li>收集所有活动域的会话列表</li>
</ol>
<p>下载地址：<a href="https://github.com/basicScandal/WinHackingBin太牛了" target="_blank" rel="noopener">https://github.com/basicScandal/WinHackingBin太牛了</a> 这里面啥都有</p>
<p>使用netsess.exe查询每个域控制器，收集所有活动域会话列表。</p>
<p><code>netsess -h</code></p>
<p>返回活动会话的IP地址、域账户、会话开始时间和空闲时间。</p>
<ol start="4">
<li>交叉引用域管理员列表与活动会话列表</li>
</ol>
<p>对域管理员列表和活动会话列表进行交叉引用，可以确定哪些IP地址有活动域令牌。</p>
<p>将域控制器列表添加到<code>doc.txt</code>中，将域管理员列表添加到<code>admins.txt</code>中，并与netsess.exe放在同一个目录下。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">FOR &#x2F;F %i in (dcs.txt) do @echo [+] Querying DC %i &amp;&amp; @netsess -h %i 2&gt;nul &gt; sessions.txt &amp;&amp; FOR &#x2F;F %a in (admins.txt) DO @type sessions.txt | @findstr &#x2F;I %a</span><br></pre></td></tr></table></figure>

<p>用GDA也可以。</p>
<h2 id="查询远程系统中运行的任务"><a href="#查询远程系统中运行的任务" class="headerlink" title="查询远程系统中运行的任务"></a>查询远程系统中运行的任务</h2><p>如果目标机器在域系统中是通过共享的本地管理员账户运行的，就可以使用下列脚本来查询系统中的域管理任务。</p>
<p>首先，从Domain Admins组中收集域管理员列表</p>
<p><code>net group &quot;Domain Admins&quot; /domain</code></p>
<p>然后运行如下脚本，将目标域系统列表添加到ips.txt中，将收集到的域管理员列表添加到names.txt文件中。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">FOR &#x2F;F %i in (ips.txt) DO @echo [+] %i &amp;&amp; @tasklist &#x2F;V &#x2F;S %i &#x2F;U user &#x2F;P password 2&gt;NUL &gt; output.txt &amp;&amp; FOR &#x2F;F %n in (names.txt) DO @type output.txt | findstr %n &gt; NUL &amp;&amp; echo [!] %n was found running a process on %i &amp;&amp; pause</span><br></pre></td></tr></table></figure>

<p>或者</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Tasklist &#x2F;s x.x.x.x &#x2F;u username  &#x2F;p password &#x2F;v</span><br></pre></td></tr></table></figure>

<p>可查看到IP地址为x.x.x.x 的远程系统的进程。/u后指Tasklist命令使用的用户账号，它必须是远程系统上的一个合法账号，/p后的“password ”指的是该用户的密码。写一个批处理，定时的对可以登录的域内服务器去跑，查看管理员是否曾经登录过。</p>
<h2 id="扫描远程系统的NetBIOS信息"><a href="#扫描远程系统的NetBIOS信息" class="headerlink" title="扫描远程系统的NetBIOS信息"></a>扫描远程系统的NetBIOS信息</h2><p>某些版本的windows系统允许用户通过NetBIOS查询已登录用户，可以利用下面的命令行脚本来扫描远程系统活跃于中的管理会话。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">FOR &#x2F;F %i in (ips.txt) do @echo [+] Checking % i &amp;&amp; nbtstat -A %i 2&gt;NUL &gt;nbsessions.txt &amp;&amp; FOR &#x2F;F %n in (admins.txt) DO @type nbsessions.txt | findstr &#x2F;I %n &gt; NUL &amp;&amp; echo [!] %n was found logged into %i</span><br></pre></td></tr></table></figure>

<p>利用nbtscan工具来收集域管理员列表。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">FOR &#x2F;F %i in (ips.txt) do @echo [+] Checking % i &amp;&amp; nbtscan -f %i 2&gt;NUL &gt;nbsessions.txt &amp;&amp; FOR &#x2F;F %n in (admins.txt) DO @type nbsessions.txt | findstr &#x2F;I %n &gt; NUL &amp;&amp; echo [!] %n was found logged into %i</span><br></pre></td></tr></table></figure>



<h2 id="利用PowerShell收集域信息"><a href="#利用PowerShell收集域信息" class="headerlink" title="利用PowerShell收集域信息"></a>利用PowerShell收集域信息</h2><p>查看脚本执行权限</p>
<p><code>Get-ExecutionPolicy</code></p>
<ul>
<li>Restricted——默认的设置， 不允许任何script运行</li>
<li>AllSigned——只能运行经过数字证书签名的script</li>
<li>RemoteSigned——运行本地的script不需要数字签名，但是运行从网络上下载的script就必须要有数字签名</li>
<li>Unrestricted——允许所有的script运行</li>
</ul>
<p>修改权限<code>Set-ExecutionPolicy Unresricted</code></p>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">Neorah</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="https://neorah.me/pentest/%E5%86%85%E7%BD%91%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86/">https://neorah.me/pentest/%E5%86%85%E7%BD%91%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/" target="_blank" rel="noopener">CC BY-NC-SA 3.0</a> unless stating additionally.</span></div></div><div class="post-meta__tag-list"></div><nav id="pagination"><div class="prev-post pull-left"><a href="/ctf/xiangyunctf/"><i class="fa fa-chevron-left">  </i><span>祥云杯2020web Writeup</span></a></div><div class="next-post pull-right"><a href="/ctf/xihulj/"><span>西湖论剑web复现</span><i class="fa fa-chevron-right"></i></a></div></nav></div></div><footer class="footer-bg" style="background-image: url(/img/top.JPG)"><div class="layout" id="footer"><div class="copyright">&copy;2020 - 2021 By Neorah</div><div class="footer_custom_text">Theme By melody</div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file-o"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="/js/third-party/anime.min.js"></script><script src="/js/third-party/jquery.min.js"></script><script src="/js/third-party/jquery.fancybox.min.js"></script><script src="/js/third-party/velocity.min.js"></script><script src="/js/third-party/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.7.0"></script><script src="/js/fancybox.js?version=1.7.0"></script><script src="/js/sidebar.js?version=1.7.0"></script><script src="/js/copy.js?version=1.7.0"></script><script src="/js/fireworks.js?version=1.7.0"></script><script src="/js/transition.js?version=1.7.0"></script><script src="/js/scroll.js?version=1.7.0"></script><script src="/js/head.js?version=1.7.0"></script><script src="/js/search/algolia.js"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script><div class="search-dialog" id="algolia-search"><div class="search-dialog__title" id="algolia-search-title">Algolia</div><div id="algolia-input-panel"><div id="algolia-search-input"></div></div><hr><div id="algolia-search-results"><div id="algolia-hits"></div><div id="algolia-pagination"></div><div id="algolia-stats"></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div></body></html>